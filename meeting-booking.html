<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>面談予約 - パートナー帯同プログラム</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        /* ヘッダー */
        .header {
            background: white;
            padding: 20px 30px;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            color: #333;
            font-size: 24px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .header-actions {
            display: flex;
            gap: 10px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
            text-decoration: none;
            display: inline-block;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #f5f5f5;
            color: #666;
        }

        .btn-secondary:hover {
            background: #e0e0e0;
        }

        /* メインコンテンツ */
        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
        }

        .content-box {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        }

        .section-title {
            font-size: 20px;
            font-weight: 600;
            color: #333;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* カレンダー */
        .calendar-container {
            animation: fadeInUp 0.5s ease;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 10px;
            color: white;
        }

        .calendar-nav {
            display: flex;
            gap: 10px;
        }

        .calendar-nav button {
            width: 35px;
            height: 35px;
            border: none;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 16px;
        }

        .calendar-nav button:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.1);
        }

        .calendar-month {
            font-size: 18px;
            font-weight: 600;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 8px;
            margin-bottom: 20px;
        }

        .calendar-day-header {
            text-align: center;
            font-size: 12px;
            font-weight: 600;
            color: #999;
            padding: 10px 0;
        }

        .calendar-day {
            aspect-ratio: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
            background: #f8f9fa;
            border: 2px solid transparent;
        }

        .calendar-day:hover {
            transform: translateY(-2px);
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
        }

        .calendar-day.disabled {
            opacity: 0.3;
            cursor: not-allowed;
            pointer-events: none;
        }

        .calendar-day.has-slots {
            background: linear-gradient(135deg, #e3f2fd 0%, #f3e5f5 100%);
            border-color: #667eea;
            font-weight: 600;
        }

        .calendar-day.has-slots:hover {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .calendar-day.selected {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-weight: 600;
        }

        .day-number {
            font-size: 16px;
        }

        .slots-indicator {
            position: absolute;
            bottom: 5px;
            font-size: 10px;
            color: #667eea;
            font-weight: 600;
        }

        .calendar-day.selected .slots-indicator,
        .calendar-day.has-slots:hover .slots-indicator {
            color: white;
        }

        /* 時間帯選択 */
        .time-slots-container {
            animation: fadeInRight 0.5s ease;
        }

        @keyframes fadeInRight {
            from {
                opacity: 0;
                transform: translateX(20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .selected-date-info {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
        }

        .selected-date-info h3 {
            font-size: 24px;
            margin-bottom: 5px;
        }

        .selected-date-info p {
            opacity: 0.9;
            font-size: 14px;
        }

        .time-slots-grid {
            display: grid;
            gap: 12px;
        }

        .time-slot {
            padding: 20px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
            overflow: hidden;
        }

        .time-slot::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            height: 100%;
            width: 4px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            transform: scaleY(0);
            transition: transform 0.3s;
        }

        .time-slot:hover::before {
            transform: scaleY(1);
        }

        .time-slot:hover {
            border-color: #667eea;
            background: #f8f9fa;
            transform: translateX(5px);
        }

        .time-slot.booked {
            opacity: 0.5;
            cursor: not-allowed;
            background: #f5f5f5;
        }

        .time-slot.booked:hover {
            transform: none;
            border-color: #e0e0e0;
        }

        .time-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .time-icon {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 20px;
        }

        .time-slot.booked .time-icon {
            background: #ccc;
        }

        .time-details h4 {
            font-size: 18px;
            color: #333;
            margin-bottom: 5px;
        }

        .time-details p {
            font-size: 13px;
            color: #666;
        }

        .slot-status {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .status-available {
            background: #e8f5e9;
            color: #2e7d32;
        }

        .status-booked {
            background: #ffebee;
            color: #c62828;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }

        .empty-state i {
            font-size: 60px;
            opacity: 0.3;
            margin-bottom: 20px;
        }

        .empty-state h3 {
            font-size: 20px;
            color: #666;
            margin-bottom: 10px;
        }

        .empty-state p {
            font-size: 14px;
        }

        /* 予約フォーム */
        .booking-form {
            animation: fadeIn 0.5s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            font-weight: 600;
            color: #333;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s;
        }

        .form-group input:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .form-group textarea {
            resize: vertical;
            min-height: 100px;
        }

        .slot-summary {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            border-left: 4px solid #667eea;
        }

        .slot-summary h4 {
            font-size: 16px;
            color: #333;
            margin-bottom: 15px;
        }

        .summary-item {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
            font-size: 14px;
            color: #666;
        }

        .summary-item i {
            color: #667eea;
            width: 20px;
        }

        .form-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .btn-full {
            flex: 1;
            padding: 15px;
            font-size: 16px;
            font-weight: 600;
        }

        /* 予約完了画面 */
        .confirmation-screen {
            text-align: center;
            animation: zoomIn 0.5s ease;
        }

        @keyframes zoomIn {
            from {
                opacity: 0;
                transform: scale(0.9);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        .success-icon {
            width: 100px;
            height: 100px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 30px;
            color: white;
            font-size: 50px;
            animation: successPulse 2s infinite;
        }

        @keyframes successPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .confirmation-screen h2 {
            font-size: 28px;
            color: #333;
            margin-bottom: 15px;
        }

        .confirmation-screen p {
            font-size: 16px;
            color: #666;
            margin-bottom: 30px;
        }

        .confirmation-details {
            background: #f8f9fa;
            padding: 30px;
            border-radius: 10px;
            margin-bottom: 30px;
            text-align: left;
        }

        .detail-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px 0;
            border-bottom: 1px solid #e0e0e0;
        }

        .detail-item:last-child {
            border-bottom: none;
        }

        .detail-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 18px;
        }

        .detail-content {
            flex: 1;
        }

        .detail-label {
            font-size: 12px;
            color: #999;
            margin-bottom: 3px;
        }

        .detail-value {
            font-size: 16px;
            font-weight: 600;
            color: #333;
        }

        /* ローディング */
        .loading {
            text-align: center;
            padding: 60px 20px;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* レスポンシブ */
        @media (max-width: 968px) {
            .main-content {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .calendar-day {
                font-size: 12px;
            }

            .day-number {
                font-size: 14px;
            }

            .slots-indicator {
                font-size: 9px;
            }
        }

        /* ヘルプテキスト */
        .help-text {
            font-size: 13px;
            color: #999;
            margin-top: 5px;
        }

        .alert {
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .alert-info {
            background: #e3f2fd;
            color: #1976d2;
            border-left: 4px solid #1976d2;
        }

        .alert i {
            font-size: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- ヘッダー -->
        <div class="header">
            <h1>
                <i class="fas fa-calendar-check"></i>
                面談予約
            </h1>
            <div class="header-actions">
                <a href="my-meetings.html" class="btn btn-secondary">
                    <i class="fas fa-list"></i> マイ予約
                </a>
                <a href="dashboard.html" class="btn btn-primary">
                    <i class="fas fa-home"></i> ダッシュボード
                </a>
            </div>
        </div>

        <!-- メインコンテンツ -->
        <div class="main-content">
            <!-- カレンダー（左側） -->
            <div class="content-box calendar-container">
                <div class="section-title">
                    <i class="fas fa-calendar-alt"></i>
                    日程を選択
                </div>

                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i>
                    <span>●印の日付は面談可能日です。日付を選択してください。</span>
                </div>

                <div class="calendar-header">
                    <div class="calendar-nav">
                        <button onclick="previousMonth()">
                            <i class="fas fa-chevron-left"></i>
                        </button>
                    </div>
                    <div class="calendar-month" id="calendarMonth"></div>
                    <div class="calendar-nav">
                        <button onclick="nextMonth()">
                            <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>
                </div>

                <div class="calendar-grid" id="calendarGrid">
                    <div class="calendar-day-header">日</div>
                    <div class="calendar-day-header">月</div>
                    <div class="calendar-day-header">火</div>
                    <div class="calendar-day-header">水</div>
                    <div class="calendar-day-header">木</div>
                    <div class="calendar-day-header">金</div>
                    <div class="calendar-day-header">土</div>
                </div>

                <div id="loading" class="loading">
                    <div class="spinner"></div>
                    <p>読み込み中...</p>
                </div>
            </div>

            <!-- 時間帯選択 / 予約フォーム（右側） -->
            <div class="content-box time-slots-container">
                <div id="emptyState" class="empty-state">
                    <i class="fas fa-hand-pointer"></i>
                    <h3>日付を選択してください</h3>
                    <p>左側のカレンダーから面談日を選んでください</p>
                </div>

                <div id="timeSlotsSection" style="display:none;">
                    <div class="section-title">
                        <i class="fas fa-clock"></i>
                        時間帯を選択
                    </div>

                    <div class="selected-date-info" id="selectedDateInfo">
                        <h3 id="selectedDateDisplay"></h3>
                        <p id="selectedDateDayOfWeek"></p>
                    </div>

                    <div class="time-slots-grid" id="timeSlotsGrid">
                        <!-- 時間帯がここに表示されます -->
                    </div>
                </div>

                <div id="bookingFormSection" style="display:none;" class="booking-form">
                    <div class="section-title">
                        <i class="fas fa-edit"></i>
                        予約情報入力
                    </div>

                    <div class="slot-summary" id="slotSummary">
                        <!-- 選択した枠の詳細 -->
                    </div>

                    <form id="bookingForm">
                        <div class="form-group">
                            <label>備考・相談内容（任意）</label>
                            <textarea id="notes" placeholder="事前に伝えておきたいことがあれば入力してください"></textarea>
                            <div class="help-text">例: 履歴書の添削をお願いしたいです</div>
                        </div>

                        <div class="form-actions">
                            <button type="button" class="btn btn-secondary btn-full" onclick="backToTimeSlots()">
                                <i class="fas fa-arrow-left"></i> 戻る
                            </button>
                            <button type="submit" class="btn btn-primary btn-full">
                                <i class="fas fa-check"></i> 予約する
                            </button>
                        </div>
                    </form>
                </div>

                <div id="confirmationSection" style="display:none;" class="confirmation-screen">
                    <div class="success-icon">
                        <i class="fas fa-check"></i>
                    </div>
                    <h2>予約が完了しました！</h2>
                    <p>予約確認メールをお送りしました</p>

                    <div class="confirmation-details" id="confirmationDetails">
                        <!-- 予約詳細 -->
                    </div>

                    <div class="form-actions">
                        <a href="my-meetings.html" class="btn btn-primary btn-full">
                            <i class="fas fa-list"></i> マイ予約を見る
                        </a>
                        <a href="dashboard.html" class="btn btn-secondary btn-full">
                            <i class="fas fa-home"></i> ダッシュボードへ
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
<script type="module">
  import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
  import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
  import {
    getFirestore,
    collection, query, where, orderBy, getDocs,
    doc, getDoc, addDoc, setDoc, runTransaction, increment,
    Timestamp, serverTimestamp
  } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

  // ==========================
  // Firebase Config（他ページと同一）
  // ==========================
  const firebaseConfig = {
    apiKey: "AIzaSyA6iFUhXOueccuoLJVU9ZSvXywHmj8zoR4",
    authDomain: "university-relocation-support.firebaseapp.com",
    projectId: "university-relocation-support",
    storageBucket: "university-relocation-support.firebasestorage.app",
    messagingSenderId: "849634495988",
    appId: "1:849634495988:web:013663976b0c4d6b4f7da1",
    measurementId: "G-RJP20TC7DV"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  // ==========================
  // State
  // ==========================
  let currentUser = null;

  // meetingSlots（個別スロット）
  let allSlots = [];

  // 統合表示用（groupKey => group）
  // group: { groupKey,date,startTime,endTime,type,location,datetime,remaining,slots:[{slotId,remaining}] }
  let groupedByKey = new Map();

  // 日付別インデックス（date => groups[]）
  let groupsByDate = new Map();

  let currentYear = new Date().getFullYear();
  let currentMonth = new Date().getMonth();

  let selectedDate = null;  // "YYYY-MM-DD"
  let selectedGroup = null; // group object

  // ==========================
  // users/{uid} 自動作成（共通仕様）
  // ==========================
  async function ensureUserDoc(user) {
    const ref = doc(db, 'users', user.uid);
    const snap = await getDoc(ref);
    if (!snap.exists()) {
      await setDoc(ref, {
        uid: user.uid,
        email: user.email || '',
        role: 'user',
        createdAt: serverTimestamp()
      }, { merge: true });
    }
    return true;
  }

  // ==========================
  // Auth Guard
  // ==========================
  onAuthStateChanged(auth, async (user) => {
    if (!user) {
      window.location.href = 'log-in.html';
      return;
    }
    currentUser = user;

    await ensureUserDoc(user);

    await loadMeetingSlotsAndBuildGroups();
    renderCalendar();
  });

  // ==========================
  // Utilities
  // ==========================
  function formatDateStr(date) {
    const y = date.getFullYear();
    const m = String(date.getMonth() + 1).padStart(2, '0');
    const d = String(date.getDate()).padStart(2, '0');
    return `${y}-${m}-${d}`;
  }

  function escapeHtml(str) {
    return String(str ?? '')
      .replaceAll('&', '&amp;')
      .replaceAll('<', '&lt;')
      .replaceAll('>', '&gt;')
      .replaceAll('"', '&quot;')
      .replaceAll("'", '&#039;');
  }

  // groupKey 設計（日時×面談タイプ×場所）
  // date/startTime/endTime/type/location を固定キーにする（Phase2へ移行しやすい）
  function buildGroupKey(slot) {
    return `${slot.date}_${slot.startTime}_${slot.endTime}_${slot.type}_${slot.location}`;
  }

  function computeSlotRemaining(slot) {
    const maxCapacity = Number(slot.maxCapacity ?? 1);
    const currentBookings = Number(slot.currentBookings ?? 0);
    return Math.max(0, maxCapacity - currentBookings);
  }

  // 方式B：重み付きランダム（remaining が大きいslotほど当たりやすい）
  function pickRandomSlotIdWeighted(group) {
    const bag = [];
    for (const s of group.slots) {
      const r = Number(s.remaining ?? 0);
      for (let i = 0; i < r; i++) bag.push(s.slotId);
    }
    if (bag.length === 0) return null;
    return bag[Math.floor(Math.random() * bag.length)];
  }

  // ==========================
  // Load + Aggregate (Phase 1 client aggregation)
  // ==========================
  async function loadMeetingSlotsAndBuildGroups() {
    try {
      document.getElementById('loading').style.display = 'block';

      const nowTs = Timestamp.fromDate(new Date());

      // ✅ meetingSlots 取得クエリ（要件）
      // - public == true
      // - status == 'available'
      // - datetime >= now
      // - orderBy datetime asc
      const q = query(
        collection(db, 'meetingSlots'),
        where('public', '==', true),
        where('status', '==', 'available'),
        where('datetime', '>=', nowTs),
        orderBy('datetime', 'asc')
      );

      const snap = await getDocs(q);

      allSlots = [];
      snap.forEach((d) => allSlots.push({ id: d.id, ...d.data() }));

      groupedByKey = new Map();
      groupsByDate = new Map();

      for (const slot of allSlots) {
        // 必須項目が欠けてるslotはスキップ（安全側）
        if (!slot.date || !slot.startTime || !slot.endTime || !slot.type || !slot.location || !slot.datetime) continue;

        const remaining = computeSlotRemaining(slot);
        if (remaining <= 0) continue;

        const groupKey = slot.groupKey || buildGroupKey(slot);

        if (!groupedByKey.has(groupKey)) {
          groupedByKey.set(groupKey, {
            groupKey,
            date: slot.date,
            startTime: slot.startTime,
            endTime: slot.endTime,
            type: slot.type,
            location: slot.location,
            datetime: slot.datetime, // ソート用
            remaining: 0,
            slots: []
          });
        }

        const g = groupedByKey.get(groupKey);
        g.remaining += remaining;
        g.slots.push({ slotId: slot.id, remaining });

        if (!groupsByDate.has(slot.date)) groupsByDate.set(slot.date, []);
      }

      // date ごとに group 配列を構築（datetime順）
      for (const g of groupedByKey.values()) {
        const arr = groupsByDate.get(g.date) || [];
        arr.push(g);
        groupsByDate.set(g.date, arr);
      }
      for (const [date, arr] of groupsByDate.entries()) {
        arr.sort((a, b) => a.datetime.toMillis() - b.datetime.toMillis());
        groupsByDate.set(date, arr);
      }

      document.getElementById('loading').style.display = 'none';

    } catch (error) {
      console.error('面談枠読み込みエラー:', error);
      document.getElementById('loading').style.display = 'none';
      alert('面談枠の読み込みに失敗しました。時間をおいて再度お試しください。');
    }
  }

  // ==========================
  // Calendar UI
  // ==========================
  function renderCalendar() {
    const monthNames = ['1月','2月','3月','4月','5月','6月','7月','8月','9月','10月','11月','12月'];
    document.getElementById('calendarMonth').textContent = `${currentYear}年 ${monthNames[currentMonth]}`;

    const firstDay = new Date(currentYear, currentMonth, 1).getDay();
    const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();

    const today = new Date();
    today.setHours(0,0,0,0);

    const grid = document.getElementById('calendarGrid');
    grid.querySelectorAll('.calendar-day').forEach(el => el.remove());

    for (let i=0; i<firstDay; i++) {
      const empty = document.createElement('div');
      empty.className = 'calendar-day disabled';
      grid.appendChild(empty);
    }

    for (let day=1; day<=daysInMonth; day++) {
      const date = new Date(currentYear, currentMonth, day);
      const dateStr = formatDateStr(date);

      const groups = groupsByDate.get(dateStr) || [];
      const remainingTotal = groups.reduce((sum, g) => sum + Number(g.remaining || 0), 0);

      const cell = document.createElement('div');
      cell.className = 'calendar-day';

      if (date < today) {
        cell.classList.add('disabled');
      } else if (remainingTotal > 0) {
        cell.classList.add('has-slots');
        cell.onclick = () => selectDate(dateStr, date);
      } else {
        cell.classList.add('disabled');
      }

      if (selectedDate === dateStr) cell.classList.add('selected');

      cell.innerHTML = `
        <span class="day-number">${day}</span>
        ${remainingTotal > 0 ? `<span class="slots-indicator">● 残${remainingTotal}</span>` : ''}
      `;
      grid.appendChild(cell);
    }
  }

  function selectDate(dateStr, dateObj) {
    selectedDate = dateStr;
    selectedGroup = null;

    renderCalendar();
    showTimeSlots(dateStr, dateObj);
  }

  // ==========================
  // Unified time slots UI（統合表示）
  // ==========================
  function showTimeSlots(dateStr, dateObj) {
    const groups = groupsByDate.get(dateStr) || [];

    document.getElementById('emptyState').style.display = 'none';
    document.getElementById('timeSlotsSection').style.display = 'block';
    document.getElementById('bookingFormSection').style.display = 'none';
    document.getElementById('confirmationSection').style.display = 'none';

    const dayNames = ['日曜日','月曜日','火曜日','水曜日','木曜日','金曜日','土曜日'];
    document.getElementById('selectedDateDisplay').textContent = dateStr.replace(/-/g,'/');
    document.getElementById('selectedDateDayOfWeek').textContent = dayNames[dateObj.getDay()];

    const grid = document.getElementById('timeSlotsGrid');
    grid.innerHTML = '';

    if (groups.length === 0) {
      grid.innerHTML = `
        <div class="empty-state">
          <i class="fas fa-calendar-times"></i>
          <h3>空き枠がありません</h3>
          <p>別の日付をお選びください</p>
        </div>
      `;
      return;
    }

    // ✅ 統合表示（残数のみを主表示。内訳は見せない）
    for (const g of groups) {
      const div = document.createElement('div');
      div.className = 'time-slot';
      div.onclick = () => selectUnifiedGroup(g);

      div.innerHTML = `
        <div class="time-info">
          <div class="time-icon"><i class="fas fa-clock"></i></div>
          <div class="time-details">
            <h4>${escapeHtml(g.startTime)} - ${escapeHtml(g.endTime)}</h4>
            <p><i class="fas fa-tag"></i> ${escapeHtml(g.type)}</p>
            <p><i class="fas fa-map-marker-alt"></i> ${escapeHtml(g.location)}</p>
          </div>
        </div>
        <div class="slot-status status-available">残り ${Number(g.remaining || 0)}</div>
      `;
      grid.appendChild(div);
    }
  }

  function selectUnifiedGroup(group) {
    selectedGroup = group;
    showBookingFormForGroup();
  }

  // ==========================
  // Booking form
  // ==========================
  function showBookingFormForGroup() {
    document.getElementById('timeSlotsSection').style.display = 'none';
    document.getElementById('bookingFormSection').style.display = 'block';

    const summary = document.getElementById('slotSummary');
    summary.innerHTML = `
      <h4>予約内容の確認</h4>
      <div class="summary-item"><i class="fas fa-calendar"></i><span>${escapeHtml(selectedGroup.date)}</span></div>
      <div class="summary-item"><i class="fas fa-clock"></i><span>${escapeHtml(selectedGroup.startTime)} - ${escapeHtml(selectedGroup.endTime)}</span></div>
      <div class="summary-item"><i class="fas fa-tag"></i><span>${escapeHtml(selectedGroup.type)}</span></div>
      <div class="summary-item"><i class="fas fa-map-marker-alt"></i><span>${escapeHtml(selectedGroup.location)}</span></div>
      <div class="summary-item"><i class="fas fa-users"></i><span>残り ${Number(selectedGroup.remaining || 0)}</span></div>
    `;
  }

  window.backToTimeSlots = function() {
    document.getElementById('bookingFormSection').style.display = 'none';
    document.getElementById('timeSlotsSection').style.display = 'block';
  };

  // ==========================
  // Booking submit
  // - 方式B：重み付きランダムでslotId選択
  // - 競合時リトライ最大3回
  // - meetingRequests に date/startTime/endTime/location を保存（YES前提）
  // ==========================
  document.getElementById('bookingForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    if (!currentUser || !selectedGroup) return;

    const notes = document.getElementById('notes').value.trim();

    const submitBtn = document.querySelector('#bookingForm button[type="submit"]');
    const originalHtml = submitBtn.innerHTML;

    try {
      submitBtn.disabled = true;
      submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 送信中...';

      const MAX_RETRY = 3;

      // 候補をローカルで保持（失敗したslotは候補から外す）
      let candidateSlots = selectedGroup.slots.map(s => ({ ...s }));

      for (let attempt = 1; attempt <= MAX_RETRY; attempt++) {
        const tmpGroup = { ...selectedGroup, slots: candidateSlots };
        const slotId = pickRandomSlotIdWeighted(tmpGroup);

        if (!slotId) break;

        // 直前に slot を再確認（競合対策）
        const slotSnap = await getDoc(doc(db, 'meetingSlots', slotId));
        if (!slotSnap.exists()) {
          candidateSlots = candidateSlots.filter(s => s.slotId !== slotId);
          continue;
        }

        const slot = slotSnap.data();
        const remaining = Math.max(0, Number(slot.maxCapacity ?? 1) - Number(slot.currentBookings ?? 0));

        // 直前チェック
        if (!(slot.public === true && slot.status === 'available' && remaining > 0)) {
          candidateSlots = candidateSlots.filter(s => s.slotId !== slotId);
          continue;
        }

        // ✅ meetingRequests 作成（担当未定: requested）
        // meetingLinkは入れない（露出防止、assignment側で管理）
        // トランザクションで予約作成と面談枠の更新を同時実行
        await runTransaction(db, async (transaction) => {
          // 1. 面談枠の現在のデータを取得
          const slotRef = doc(db, 'meetingSlots', slotId);
          const slotDoc = await transaction.get(slotRef);
  
          if (!slotDoc.exists()) {
            throw new Error('面談枠が見つかりません');
          }
  
          const slotData = slotDoc.data();
  
          // 2. 空きがあるかチェック
          const currentBookings = slotData.currentBookings || 0;
          const maxCapacity = slotData.maxCapacity || 1;
  
          if (currentBookings >= maxCapacity) {
            throw new Error('満席');
          }
  
          // 3. 予約ドキュメントを作成
          const requestRef = doc(collection(db, 'meetingRequests'));
          transaction.set(requestRef, {
            slotId,
            userId: currentUser.uid,
            requestedType: selectedGroup.type,
            location: selectedGroup.location,
            date: selectedGroup.date,
            startTime: selectedGroup.startTime,
            endTime: selectedGroup.endTime,
            status: 'requested',
            requestedAt: serverTimestamp(),
            userMessage: notes || ''
          });
  
          // 4. 面談枠の currentBookings を +1
          const newBookings = currentBookings + 1;
          const updateData = {
            currentBookings: increment(1)
          };
  
          // 5. 満席になったら status を変更
          if (newBookings >= maxCapacity) {
            updateData.status = 'full';
          }
  
          transaction.update(slotRef, updateData);
        };


        // ✅ meetingRequests 作成（担当未定: requested）
// meetingLinkは入れない（露出防止、assignment側で管理）
try {
  // トランザクションで予約作成と面談枠の更新を同時実行
  await runTransaction(db, async (transaction) => {
    // 1. 面談枠の現在のデータを取得
    const slotRef = doc(db, 'meetingSlots', slotId);
    const slotDoc = await transaction.get(slotRef);
    
    if (!slotDoc.exists()) {
      throw new Error('面談枠が見つかりません');
    }
    
    const slotData = slotDoc.data();
    
    // 2. 空きがあるかチェック
    const currentBookings = slotData.currentBookings || 0;
    const maxCapacity = slotData.maxCapacity || 1;
    
    if (currentBookings >= maxCapacity) {
      throw new Error('満席');
    }
    
    // 3. 予約ドキュメントを作成
    const requestRef = doc(collection(db, 'meetingRequests'));
    transaction.set(requestRef, {
      slotId,
      userId: currentUser.uid,
      requestedType: selectedGroup.type,
      location: selectedGroup.location,
      date: selectedGroup.date,
      startTime: selectedGroup.startTime,
      endTime: selectedGroup.endTime,
      status: 'requested',
      requestedAt: serverTimestamp(),
      userMessage: notes || ''
    });
    
    // 4. 面談枠の currentBookings を +1
    const newBookings = currentBookings + 1;
    const updateData = {
      currentBookings: increment(1)
    };
    
    // 5. 満席になったら status を変更
    if (newBookings >= maxCapacity) {
      updateData.status = 'full';
    }
    
    transaction.update(slotRef, updateData);
  });
  
  // 完了UI
  showConfirmationRequested();
  
  // 体感改善：再取得（ただしPhase1なので"残数の完全一致"は保証できない）
  await loadMeetingSlotsAndBuildGroups();
  
} catch (error) {
  console.error('❌ 予約エラー:', error);
  
  // エラーメッセージの表示
  if (error.message === '満席') {
    alert('申し訳ございません。この面談枠は満席になりました。\n他の日時をお選びください。');
  } else if (error.message === '面談枠が見つかりません') {
    alert('面談枠が見つかりませんでした。\nページを更新してもう一度お試しください。');
  } else {
    alert('予約処理中にエラーが発生しました。\nもう一度お試しください。');
  }
  
  // エラー時も再読み込み（最新状態を反映）
  await loadMeetingSlotsAndBuildGroups();
}

  );

  function showConfirmationRequested() {
    document.getElementById('bookingFormSection').style.display = 'none';
    document.getElementById('confirmationSection').style.display = 'block';

    const title = document.querySelector('#confirmationSection h2');
    const desc = document.querySelector('#confirmationSection p');
    if (title) title.textContent = '受付しました';
    if (desc) desc.textContent = '受付済（担当者調整中）です。担当者が確定次第、マイ予約でご確認いただけます。';

    const details = document.getElementById('confirmationDetails');
    details.innerHTML = `
      <div class="detail-item">
        <div class="detail-icon"><i class="fas fa-calendar"></i></div>
        <div class="detail-content">
          <div class="detail-label">日付</div>
          <div class="detail-value">${escapeHtml(selectedGroup.date)}</div>
        </div>
      </div>
      <div class="detail-item">
        <div class="detail-icon"><i class="fas fa-clock"></i></div>
        <div class="detail-content">
          <div class="detail-label">時間</div>
          <div class="detail-value">${escapeHtml(selectedGroup.startTime)} - ${escapeHtml(selectedGroup.endTime)}</div>
        </div>
      </div>
      <div class="detail-item">
        <div class="detail-icon"><i class="fas fa-tag"></i></div>
        <div class="detail-content">
          <div class="detail-label">面談タイプ</div>
          <div class="detail-value">${escapeHtml(selectedGroup.type)}</div>
        </div>
      </div>
      <div class="detail-item">
        <div class="detail-icon"><i class="fas fa-map-marker-alt"></i></div>
        <div class="detail-content">
          <div class="detail-label">場所</div>
          <div class="detail-value">${escapeHtml(selectedGroup.location)}</div>
        </div>
      </div>
      <div class="detail-item">
        <div class="detail-icon"><i class="fas fa-hourglass-half"></i></div>
        <div class="detail-content">
          <div class="detail-label">ステータス</div>
          <div class="detail-value">受付済（担当者調整中）</div>
        </div>
      </div>
    `;
  }

  // ==========================
  // Calendar navigation（既存HTMLのonclickに対応）
  // ==========================
  window.previousMonth = function() {
    if (currentMonth === 0) { currentMonth = 11; currentYear--; }
    else currentMonth--;
    renderCalendar();
  };

  window.nextMonth = function() {
    if (currentMonth === 11) { currentMonth = 0; currentYear++; }
    else currentMonth++;
    renderCalendar();
  };
</script>

</body>
</html>
