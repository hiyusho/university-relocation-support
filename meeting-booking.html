<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é¢è«‡äºˆç´„ - ç•™å­¦ç”Ÿæ”¯æ´ã‚µãƒ¼ãƒ“ã‚¹</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        /* ãƒ˜ãƒƒãƒ€ãƒ¼ */
        .header {
            background: white;
            padding: 20px 30px;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            color: #333;
            font-size: 24px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .header-actions {
            display: flex;
            gap: 10px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
            text-decoration: none;
            display: inline-block;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #f5f5f5;
            color: #666;
        }

        .btn-secondary:hover {
            background: #e0e0e0;
        }

        /* ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ */
        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
        }

        .content-box {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        }

        .section-title {
            font-size: 20px;
            font-weight: 600;
            color: #333;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ */
        .calendar-container {
            animation: fadeInUp 0.5s ease;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 10px;
            color: white;
        }

        .calendar-nav {
            display: flex;
            gap: 10px;
        }

        .calendar-nav button {
            width: 35px;
            height: 35px;
            border: none;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 16px;
        }

        .calendar-nav button:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.1);
        }

        .calendar-month {
            font-size: 18px;
            font-weight: 600;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 8px;
            margin-bottom: 20px;
        }

        .calendar-day-header {
            text-align: center;
            font-size: 12px;
            font-weight: 600;
            color: #999;
            padding: 10px 0;
        }

        .calendar-day {
            aspect-ratio: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
            background: #f8f9fa;
            border: 2px solid transparent;
        }

        .calendar-day:hover {
            transform: translateY(-2px);
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
        }

        .calendar-day.disabled {
            opacity: 0.3;
            cursor: not-allowed;
            pointer-events: none;
        }

        .calendar-day.has-slots {
            background: linear-gradient(135deg, #e3f2fd 0%, #f3e5f5 100%);
            border-color: #667eea;
            font-weight: 600;
        }

        .calendar-day.has-slots:hover {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .calendar-day.selected {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-weight: 600;
        }

        .day-number {
            font-size: 16px;
        }

        .slots-indicator {
            position: absolute;
            bottom: 5px;
            font-size: 10px;
            color: #667eea;
            font-weight: 600;
        }

        .calendar-day.selected .slots-indicator,
        .calendar-day.has-slots:hover .slots-indicator {
            color: white;
        }

        /* æ™‚é–“å¸¯é¸æŠ */
        .time-slots-container {
            animation: fadeInRight 0.5s ease;
        }

        @keyframes fadeInRight {
            from {
                opacity: 0;
                transform: translateX(20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .selected-date-info {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
        }

        .selected-date-info h3 {
            font-size: 24px;
            margin-bottom: 5px;
        }

        .selected-date-info p {
            opacity: 0.9;
            font-size: 14px;
        }

        .time-slots-grid {
            display: grid;
            gap: 12px;
        }

        .time-slot {
            padding: 20px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
            overflow: hidden;
        }

        .time-slot::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            height: 100%;
            width: 4px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            transform: scaleY(0);
            transition: transform 0.3s;
        }

        .time-slot:hover::before {
            transform: scaleY(1);
        }

        .time-slot:hover {
            border-color: #667eea;
            background: #f8f9fa;
            transform: translateX(5px);
        }

        .time-slot.booked {
            opacity: 0.5;
            cursor: not-allowed;
            background: #f5f5f5;
        }

        .time-slot.booked:hover {
            transform: none;
            border-color: #e0e0e0;
        }

        .time-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .time-icon {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 20px;
        }

        .time-slot.booked .time-icon {
            background: #ccc;
        }

        .time-details h4 {
            font-size: 18px;
            color: #333;
            margin-bottom: 5px;
        }

        .time-details p {
            font-size: 13px;
            color: #666;
        }

        .slot-status {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .status-available {
            background: #e8f5e9;
            color: #2e7d32;
        }

        .status-booked {
            background: #ffebee;
            color: #c62828;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }

        .empty-state i {
            font-size: 60px;
            opacity: 0.3;
            margin-bottom: 20px;
        }

        .empty-state h3 {
            font-size: 20px;
            color: #666;
            margin-bottom: 10px;
        }

        .empty-state p {
            font-size: 14px;
        }

        /* äºˆç´„ãƒ•ã‚©ãƒ¼ãƒ  */
        .booking-form {
            animation: fadeIn 0.5s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            font-weight: 600;
            color: #333;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s;
        }

        .form-group input:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .form-group textarea {
            resize: vertical;
            min-height: 100px;
        }

        .slot-summary {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            border-left: 4px solid #667eea;
        }

        .slot-summary h4 {
            font-size: 16px;
            color: #333;
            margin-bottom: 15px;
        }

        .summary-item {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
            font-size: 14px;
            color: #666;
        }

        .summary-item i {
            color: #667eea;
            width: 20px;
        }

        .form-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .btn-full {
            flex: 1;
            padding: 15px;
            font-size: 16px;
            font-weight: 600;
        }

        /* äºˆç´„å®Œäº†ç”»é¢ */
        .confirmation-screen {
            text-align: center;
            animation: zoomIn 0.5s ease;
        }

        @keyframes zoomIn {
            from {
                opacity: 0;
                transform: scale(0.9);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        .success-icon {
            width: 100px;
            height: 100px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 30px;
            color: white;
            font-size: 50px;
            animation: successPulse 2s infinite;
        }

        @keyframes successPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .confirmation-screen h2 {
            font-size: 28px;
            color: #333;
            margin-bottom: 15px;
        }

        .confirmation-screen p {
            font-size: 16px;
            color: #666;
            margin-bottom: 30px;
        }

        .confirmation-details {
            background: #f8f9fa;
            padding: 30px;
            border-radius: 10px;
            margin-bottom: 30px;
            text-align: left;
        }

        .detail-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px 0;
            border-bottom: 1px solid #e0e0e0;
        }

        .detail-item:last-child {
            border-bottom: none;
        }

        .detail-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 18px;
        }

        .detail-content {
            flex: 1;
        }

        .detail-label {
            font-size: 12px;
            color: #999;
            margin-bottom: 3px;
        }

        .detail-value {
            font-size: 16px;
            font-weight: 600;
            color: #333;
        }

        /* ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚° */
        .loading {
            text-align: center;
            padding: 60px 20px;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ– */
        @media (max-width: 968px) {
            .main-content {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .calendar-day {
                font-size: 12px;
            }

            .day-number {
                font-size: 14px;
            }

            .slots-indicator {
                font-size: 9px;
            }
        }

        /* ãƒ˜ãƒ«ãƒ—ãƒ†ã‚­ã‚¹ãƒˆ */
        .help-text {
            font-size: 13px;
            color: #999;
            margin-top: 5px;
        }

        .alert {
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .alert-info {
            background: #e3f2fd;
            color: #1976d2;
            border-left: 4px solid #1976d2;
        }

        .alert i {
            font-size: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
        <div class="header">
            <h1>
                <i class="fas fa-calendar-check"></i>
                é¢è«‡äºˆç´„
            </h1>
            <div class="header-actions">
                <a href="my-meetings.html" class="btn btn-secondary">
                    <i class="fas fa-list"></i> ãƒã‚¤äºˆç´„
                </a>
                <a href="dashboard.html" class="btn btn-primary">
                    <i class="fas fa-home"></i> ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰
                </a>
            </div>
        </div>

        <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
        <div class="main-content">
            <!-- ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ï¼ˆå·¦å´ï¼‰ -->
            <div class="content-box calendar-container">
                <div class="section-title">
                    <i class="fas fa-calendar-alt"></i>
                    æ—¥ç¨‹ã‚’é¸æŠ
                </div>

                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i>
                    <span>â—å°ã®æ—¥ä»˜ã¯é¢è«‡å¯èƒ½æ—¥ã§ã™ã€‚æ—¥ä»˜ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚</span>
                </div>

                <div class="calendar-header">
                    <div class="calendar-nav">
                        <button onclick="previousMonth()">
                            <i class="fas fa-chevron-left"></i>
                        </button>
                    </div>
                    <div class="calendar-month" id="calendarMonth"></div>
                    <div class="calendar-nav">
                        <button onclick="nextMonth()">
                            <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>
                </div>

                <div class="calendar-grid" id="calendarGrid">
                    <div class="calendar-day-header">æ—¥</div>
                    <div class="calendar-day-header">æœˆ</div>
                    <div class="calendar-day-header">ç«</div>
                    <div class="calendar-day-header">æ°´</div>
                    <div class="calendar-day-header">æœ¨</div>
                    <div class="calendar-day-header">é‡‘</div>
                    <div class="calendar-day-header">åœŸ</div>
                </div>

                <div id="loading" class="loading">
                    <div class="spinner"></div>
                    <p>èª­ã¿è¾¼ã¿ä¸­...</p>
                </div>
            </div>

            <!-- æ™‚é–“å¸¯é¸æŠ / äºˆç´„ãƒ•ã‚©ãƒ¼ãƒ ï¼ˆå³å´ï¼‰ -->
            <div class="content-box time-slots-container">
                <div id="emptyState" class="empty-state">
                    <i class="fas fa-hand-pointer"></i>
                    <h3>æ—¥ä»˜ã‚’é¸æŠã—ã¦ãã ã•ã„</h3>
                    <p>å·¦å´ã®ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‹ã‚‰é¢è«‡æ—¥ã‚’é¸ã‚“ã§ãã ã•ã„</p>
                </div>

                <div id="timeSlotsSection" style="display:none;">
                    <div class="section-title">
                        <i class="fas fa-clock"></i>
                        æ™‚é–“å¸¯ã‚’é¸æŠ
                    </div>

                    <div class="selected-date-info" id="selectedDateInfo">
                        <h3 id="selectedDateDisplay"></h3>
                        <p id="selectedDateDayOfWeek"></p>
                    </div>

                    <div class="time-slots-grid" id="timeSlotsGrid">
                        <!-- æ™‚é–“å¸¯ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ -->
                    </div>
                </div>

                <div id="bookingFormSection" style="display:none;" class="booking-form">
                    <div class="section-title">
                        <i class="fas fa-edit"></i>
                        äºˆç´„æƒ…å ±å…¥åŠ›
                    </div>

                    <div class="slot-summary" id="slotSummary">
                        <!-- é¸æŠã—ãŸæ ã®è©³ç´° -->
                    </div>

                    <form id="bookingForm">
                        <div class="form-group">
                            <label>å‚™è€ƒãƒ»ç›¸è«‡å†…å®¹ï¼ˆä»»æ„ï¼‰</label>
                            <textarea id="notes" placeholder="äº‹å‰ã«ä¼ãˆã¦ãŠããŸã„ã“ã¨ãŒã‚ã‚Œã°å…¥åŠ›ã—ã¦ãã ã•ã„"></textarea>
                            <div class="help-text">ä¾‹: å±¥æ­´æ›¸ã®æ·»å‰Šã‚’ãŠé¡˜ã„ã—ãŸã„ã§ã™</div>
                        </div>

                        <div class="form-actions">
                            <button type="button" class="btn btn-secondary btn-full" onclick="backToTimeSlots()">
                                <i class="fas fa-arrow-left"></i> æˆ»ã‚‹
                            </button>
                            <button type="submit" class="btn btn-primary btn-full">
                                <i class="fas fa-check"></i> äºˆç´„ã™ã‚‹
                            </button>
                        </div>
                    </form>
                </div>

                <div id="confirmationSection" style="display:none;" class="confirmation-screen">
                    <div class="success-icon">
                        <i class="fas fa-check"></i>
                    </div>
                    <h2>äºˆç´„ãŒå®Œäº†ã—ã¾ã—ãŸï¼</h2>
                    <p>äºˆç´„ç¢ºèªãƒ¡ãƒ¼ãƒ«ã‚’ãŠé€ã‚Šã—ã¾ã—ãŸ</p>

                    <div class="confirmation-details" id="confirmationDetails">
                        <!-- äºˆç´„è©³ç´° -->
                    </div>

                    <div class="form-actions">
                        <a href="my-meetings.html" class="btn btn-primary btn-full">
                            <i class="fas fa-list"></i> ãƒã‚¤äºˆç´„ã‚’è¦‹ã‚‹
                        </a>
                        <a href="dashboard.html" class="btn btn-secondary btn-full">
                            <i class="fas fa-home"></i> ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã¸
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
<script type="module">
  import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
  import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
  import {
    getFirestore,
    collection, query, where, orderBy, getDocs,
    doc, getDoc, addDoc,
    Timestamp, serverTimestamp
  } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

  // ==========================
  // Firebase Config
  // ==========================
  const firebaseConfig = {
    apiKey: "AIzaSyA6iFUhXOueccuoLJVU9ZSvXywHmj8zoR4",
    authDomain: "university-relocation-support.firebaseapp.com",
    projectId: "university-relocation-support",
    storageBucket: "university-relocation-support.firebasestorage.app",
    messagingSenderId: "849634495988",
    appId: "1:849634495988:web:013663976b0c4d6b4f7da1",
    measurementId: "G-RJP20TC7DV"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  // ==========================
  // State
  // ==========================
  let currentUser = null;

  // meetingSlotsï¼ˆå€‹åˆ¥ã‚¹ãƒ­ãƒƒãƒˆï¼‰
  let allSlots = [];

  // çµ±åˆè¡¨ç¤ºç”¨ï¼ˆgroupKey => groupï¼‰
  // group: { groupKey,date,startTime,endTime,type,location,datetime,remaining,slots:[{slotId,remaining}] }
  let groupedByKey = new Map();

  // æ—¥ä»˜åˆ¥ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ï¼ˆdate => groups[]ï¼‰
  let groupsByDate = new Map();

  let currentYear = new Date().getFullYear();
  let currentMonth = new Date().getMonth();

  let selectedDate = null;     // "YYYY-MM-DD"
  let selectedGroup = null;    // ä¸Šè¨˜ group ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ

  // ==========================
  // Auth Guard
  // ==========================
  onAuthStateChanged(auth, async (user) => {
    if (!user) {
      window.location.href = 'log-in.html';
      return;
    }
    currentUser = user;

    await loadMeetingSlotsAndBuildGroups();
    renderCalendar();
  });

  // ==========================
  // Utilities
  // ==========================
  function formatDateStr(date) {
    const year = date.getFullYear();
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const day = String(date.getDate()).padStart(2, '0');
    return `${year}-${month}-${day}`;
  }

  function escapeHtml(str) {
    return String(str ?? '')
      .replaceAll('&', '&amp;')
      .replaceAll('<', '&lt;')
      .replaceAll('>', '&gt;')
      .replaceAll('"', '&quot;')
      .replaceAll("'", '&#039;');
  }

  function buildGroupKey(slot) {
    // çµ±åˆæ¡ä»¶ï¼šæ—¥æ™‚Ã—é¢è«‡ã‚¿ã‚¤ãƒ—Ã—å ´æ‰€ï¼ˆendTimeã‚‚å«ã‚ã‚‹ï¼‰
    // date/startTime/endTime/type/location ã¯ slot ã«å…¥ã£ã¦ã„ã‚‹å‰æï¼ˆç¾è¡Œ admin å´ä½œæˆãƒ­ã‚¸ãƒƒã‚¯ã¨æ•´åˆï¼‰
    return `${slot.date}_${slot.startTime}_${slot.endTime}_${slot.type}_${slot.location}`;
  }

  function computeSlotRemaining(slot) {
    const maxCapacity = Number(slot.maxCapacity ?? 1);
    const currentBookings = Number(slot.currentBookings ?? 0);
    return Math.max(0, maxCapacity - currentBookings);
  }

  // é‡ã¿ä»˜ããƒ©ãƒ³ãƒ€ãƒ ï¼šremaining åˆ†ã ã‘æŠ½é¸ç¢ºç‡ã‚’å¢—ã‚„ã™
  function pickRandomSlotIdWeighted(group) {
    // group.slots = [{slotId, remaining}]
    const bag = [];
    for (const s of group.slots) {
      const r = Number(s.remaining ?? 0);
      for (let i = 0; i < r; i++) bag.push(s.slotId);
    }
    if (bag.length === 0) return null;
    return bag[Math.floor(Math.random() * bag.length)];
  }

  // ==========================
  // Load + Aggregate (Phase 1 client aggregation)
  // ==========================
  async function loadMeetingSlotsAndBuildGroups() {
    try {
      console.log('ğŸ“… é¢è«‡æ ã‚’èª­ã¿è¾¼ã¿ä¸­ï¼ˆçµ±åˆè¡¨ç¤ºç”¨ï¼‰...');
      document.getElementById('loading').style.display = 'block';

      const nowTs = Timestamp.fromDate(new Date());

      // â˜… meetingSlots å–å¾—ã‚¯ã‚¨ãƒªï¼ˆpublic==true ã®ã¿ã‚’å¯¾è±¡ï¼‰
      // - status == available
      // - datetime >= now
      // - orderBy datetime asc
      const q = query(
        collection(db, 'meetingSlots'),
        where('public', '==', true),
        where('status', '==', 'available'),
        where('datetime', '>=', nowTs),
        orderBy('datetime', 'asc')
      );

      const snap = await getDocs(q);

      allSlots = [];
      snap.forEach((d) => {
        allSlots.push({ id: d.id, ...d.data() });
      });

      // é›†è¨ˆ
      groupedByKey = new Map();
      groupsByDate = new Map();

      for (const slot of allSlots) {
        // å¿…é ˆé …ç›®ãŒæ¬ ã‘ã¦ã‚‹slotã¯ã‚¹ã‚­ãƒƒãƒ—ï¼ˆå®‰å…¨å´ï¼‰
        if (!slot.date || !slot.startTime || !slot.endTime || !slot.type || !slot.location || !slot.datetime) continue;

        const remaining = computeSlotRemaining(slot);
        if (remaining <= 0) continue;

        const groupKey = slot.groupKey || buildGroupKey(slot);

        if (!groupedByKey.has(groupKey)) {
          groupedByKey.set(groupKey, {
            groupKey,
            date: slot.date,
            startTime: slot.startTime,
            endTime: slot.endTime,
            type: slot.type,
            location: slot.location,
            datetime: slot.datetime,
            remaining: 0,
            slots: []
          });
        }

        const g = groupedByKey.get(groupKey);
        g.remaining += remaining;
        g.slots.push({ slotId: slot.id, remaining });

        if (!groupsByDate.has(slot.date)) groupsByDate.set(slot.date, []);
      }

      // date ã”ã¨ã« group é…åˆ—ã‚’æ§‹ç¯‰ï¼ˆdatetimeé †ï¼‰
      for (const g of groupedByKey.values()) {
        const arr = groupsByDate.get(g.date) || [];
        arr.push(g);
        groupsByDate.set(g.date, arr);
      }
      for (const [date, arr] of groupsByDate.entries()) {
        arr.sort((a, b) => a.datetime.toMillis() - b.datetime.toMillis());
        groupsByDate.set(date, arr);
      }

      console.log('âœ… meetingSlots:', allSlots.length, 'ä»¶ / groups:', groupedByKey.size, 'ä»¶');
      document.getElementById('loading').style.display = 'none';

    } catch (error) {
      console.error('âŒ é¢è«‡æ èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
      document.getElementById('loading').style.display = 'none';
      alert('é¢è«‡æ ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚æ™‚é–“ã‚’ãŠã„ã¦å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚');
    }
  }

  // ==========================
  // Calendar UI
  // ==========================
  function renderCalendar() {
    const monthNames = ['1æœˆ','2æœˆ','3æœˆ','4æœˆ','5æœˆ','6æœˆ','7æœˆ','8æœˆ','9æœˆ','10æœˆ','11æœˆ','12æœˆ'];
    document.getElementById('calendarMonth').textContent = `${currentYear}å¹´ ${monthNames[currentMonth]}`;

    const firstDay = new Date(currentYear, currentMonth, 1).getDay();
    const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();

    const today = new Date();
    today.setHours(0,0,0,0);

    const grid = document.getElementById('calendarGrid');

    // æ—¢å­˜ã‚»ãƒ«ã‚’å‰Šé™¤
    grid.querySelectorAll('.calendar-day').forEach(el => el.remove());

    // æœˆåˆç©ºç™½
    for (let i=0; i<firstDay; i++) {
      const empty = document.createElement('div');
      empty.className = 'calendar-day disabled';
      grid.appendChild(empty);
    }

    // æ—¥ä»˜ã‚»ãƒ«
    for (let day=1; day<=daysInMonth; day++) {
      const date = new Date(currentYear, currentMonth, day);
      const dateStr = formatDateStr(date);

      const dayCell = document.createElement('div');
      dayCell.className = 'calendar-day';

      const groups = groupsByDate.get(dateStr) || [];
      const remainingTotal = groups.reduce((sum, g) => sum + Number(g.remaining || 0), 0);

      if (date < today) {
        dayCell.classList.add('disabled');
      } else if (remainingTotal > 0) {
        dayCell.classList.add('has-slots');
        dayCell.onclick = () => selectDate(dateStr, date);
      } else {
        dayCell.classList.add('disabled');
      }

      if (selectedDate === dateStr) dayCell.classList.add('selected');

      dayCell.innerHTML = `
        <span class="day-number">${day}</span>
        ${remainingTotal > 0 ? `<span class="slots-indicator">â— æ®‹${remainingTotal}</span>` : ''}
      `;

      grid.appendChild(dayCell);
    }
  }

  function selectDate(dateStr, dateObj) {
    selectedDate = dateStr;
    selectedGroup = null;

    renderCalendar();
    showTimeSlots(dateStr, dateObj);
  }

  // ==========================
  // Time slots UI (Unified list)
  // ==========================
  function showTimeSlots(dateStr, dateObj) {
    const groups = groupsByDate.get(dateStr) || [];

    document.getElementById('emptyState').style.display = 'none';
    document.getElementById('timeSlotsSection').style.display = 'block';
    document.getElementById('bookingFormSection').style.display = 'none';
    document.getElementById('confirmationSection').style.display = 'none';

    const dayNames = ['æ—¥æ›œæ—¥','æœˆæ›œæ—¥','ç«æ›œæ—¥','æ°´æ›œæ—¥','æœ¨æ›œæ—¥','é‡‘æ›œæ—¥','åœŸæ›œæ—¥'];
    document.getElementById('selectedDateDisplay').textContent = dateStr.replace(/-/g,'/');
    document.getElementById('selectedDateDayOfWeek').textContent = dayNames[dateObj.getDay()];

    const grid = document.getElementById('timeSlotsGrid');
    grid.innerHTML = '';

    if (groups.length === 0) {
      grid.innerHTML = `
        <div class="empty-state">
          <i class="fas fa-calendar-times"></i>
          <h3>ç©ºãæ ãŒã‚ã‚Šã¾ã›ã‚“</h3>
          <p>åˆ¥ã®æ—¥ä»˜ã‚’ãŠé¸ã³ãã ã•ã„</p>
        </div>
      `;
      return;
    }

    // â˜…çµ±åˆè¡¨ç¤ºï¼šæ®‹æ•°ã®ã¿ï¼ˆtype/locationã¯æ ã®å±æ€§ã¨ã—ã¦è¡¨ç¤ºã€æ‹…å½“è€…å†…è¨³ã¯éè¡¨ç¤ºï¼‰
    for (const g of groups) {
      const div = document.createElement('div');
      div.className = 'time-slot';
      div.onclick = () => selectUnifiedGroup(g);

      div.innerHTML = `
        <div class="time-info">
          <div class="time-icon"><i class="fas fa-clock"></i></div>
          <div class="time-details">
            <h4>${escapeHtml(g.startTime)} - ${escapeHtml(g.endTime)}</h4>
            <p><i class="fas fa-tag"></i> ${escapeHtml(g.type)}</p>
            <p><i class="fas fa-map-marker-alt"></i> ${escapeHtml(g.location)}</p>
          </div>
        </div>
        <div class="slot-status status-available">
          æ®‹ã‚Š ${Number(g.remaining || 0)}
        </div>
      `;
      grid.appendChild(div);
    }
  }

  function selectUnifiedGroup(group) {
    selectedGroup = group;
    showBookingFormForGroup();
  }

  // ==========================
  // Booking form
  // ==========================
  function showBookingFormForGroup() {
    document.getElementById('timeSlotsSection').style.display = 'none';
    document.getElementById('bookingFormSection').style.display = 'block';

    const summary = document.getElementById('slotSummary');
    summary.innerHTML = `
      <h4>äºˆç´„å†…å®¹ã®ç¢ºèª</h4>
      <div class="summary-item"><i class="fas fa-calendar"></i><span>${escapeHtml(selectedGroup.date)}</span></div>
      <div class="summary-item"><i class="fas fa-clock"></i><span>${escapeHtml(selectedGroup.startTime)} - ${escapeHtml(selectedGroup.endTime)}</span></div>
      <div class="summary-item"><i class="fas fa-tag"></i><span>${escapeHtml(selectedGroup.type)}</span></div>
      <div class="summary-item"><i class="fas fa-map-marker-alt"></i><span>${escapeHtml(selectedGroup.location)}</span></div>
      <div class="summary-item"><i class="fas fa-users"></i><span>æ®‹ã‚Š ${Number(selectedGroup.remaining || 0)}</span></div>
    `;
  }

  // æˆ»ã‚‹
  window.backToTimeSlots = function() {
    document.getElementById('bookingFormSection').style.display = 'none';
    document.getElementById('timeSlotsSection').style.display = 'block';
  };

  // ==========================
  // Booking submit (Phase1: create meetingRequests)
  // - weighted random slot selection
  // - conflict retry up to 3
  // ==========================
  document.getElementById('bookingForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    if (!currentUser || !selectedGroup) return;

    const notes = document.getElementById('notes').value.trim();

    try {
      // ãƒœã‚¿ãƒ³äºŒé‡é€ä¿¡å¯¾ç­–
      const submitBtn = document.querySelector('#bookingForm button[type="submit"]');
      const originalHtml = submitBtn.innerHTML;
      submitBtn.disabled = true;
      submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> é€ä¿¡ä¸­...';

      const MAX_RETRY = 3;

      // ã‚³ãƒ”ãƒ¼ã—ã¦å£Šã•ãªã„ã‚ˆã†ã«ã™ã‚‹ï¼ˆãƒªãƒˆãƒ©ã‚¤ä¸­ã«å€™è£œã‚’å‰Šã‚‹ï¼‰
      let candidateSlots = selectedGroup.slots.map(s => ({...s}));

      for (let attempt = 1; attempt <= MAX_RETRY; attempt++) {
        // groupã®å€™è£œã‚’å·®ã—æ›¿ãˆï¼ˆé‡ã¿ä»˜ãæŠ½é¸ãŒåŠ¹ãã‚ˆã†ã«ï¼‰
        const tmpGroup = { ...selectedGroup, slots: candidateSlots };

        const slotId = pickRandomSlotIdWeighted(tmpGroup);
        if (!slotId) break;

        // ç›´å‰ã« slot ã‚’å†ç¢ºèªï¼ˆç«¶åˆå¯¾ç­–ï¼‰
        const slotSnap = await getDoc(doc(db, 'meetingSlots', slotId));
        if (!slotSnap.exists()) {
          candidateSlots = candidateSlots.filter(s => s.slotId !== slotId);
          continue;
        }

        const slot = slotSnap.data();
        const remaining = Math.max(0, Number(slot.maxCapacity ?? 1) - Number(slot.currentBookings ?? 0));

        // å…¬é–‹ï¼†åˆ©ç”¨å¯èƒ½ï¼†åœ¨åº«ã‚ã‚Šã®ã¨ãã ã‘ç”³è«‹ã‚’ä½œã‚‹
        if (!(slot.public === true && slot.status === 'available' && remaining > 0)) {
          // åŸ‹ã¾ã£ã¦ãŸ or éå…¬é–‹ã«ãªã£ãŸ
          candidateSlots = candidateSlots.filter(s => s.slotId !== slotId);
          continue;
        }

        // meetingRequests ä½œæˆï¼ˆæ‹…å½“æœªç¢ºå®š: requestedï¼‰
        await addDoc(collection(db, 'meetingRequests'), {
          slotId: slotId,
          userId: currentUser.uid,
          requestedType: selectedGroup.type,
          status: 'requested',
          requestedAt: serverTimestamp(),
          userMessage: notes || ''
        });

        // UIï¼šå®Œäº†ç”»é¢ï¼ˆå—ä»˜æ¸ˆï¼æ‹…å½“è€…èª¿æ•´ä¸­ï¼‰
        showConfirmationRequested();
        // å†èª­ã¿è¾¼ã¿ï¼ˆæ®‹æ•°åæ˜ ã¯ Phase1ã§ã¯å®Œå…¨ã§ã¯ãªã„ãŒã€ä½“æ„Ÿã‚’è‰¯ãã™ã‚‹ï¼‰
        await loadMeetingSlotsAndBuildGroups();
        renderCalendar();

        submitBtn.disabled = false;
        submitBtn.innerHTML = originalHtml;
        return;
      }

      // 3å›å¤±æ•—
      alert('ç”³ã—è¨³ã‚ã‚Šã¾ã›ã‚“ã€‚ç©ºãæ ã®ç¢ºä¿ã«å¤±æ•—ã—ã¾ã—ãŸï¼ˆä»–ã®æ–¹ã®äºˆç´„ãŒé‡ãªã£ãŸå¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ï¼‰ã€‚åˆ¥ã®æ ã‚’ãŠè©¦ã—ãã ã•ã„ã€‚');

      submitBtn.disabled = false;
      submitBtn.innerHTML = originalHtml;

    } catch (error) {
      console.error('âŒ äºˆç´„ç”³è«‹ã‚¨ãƒ©ãƒ¼:', error);
      alert('äºˆç´„ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚');
      const submitBtn = document.querySelector('#bookingForm button[type="submit"]');
      if (submitBtn) {
        submitBtn.disabled = false;
        submitBtn.innerHTML = '<i class="fas fa-check"></i> äºˆç´„ã™ã‚‹';
      }
    }
  });

  function showConfirmationRequested() {
    document.getElementById('bookingFormSection').style.display = 'none';
    document.getElementById('confirmationSection').style.display = 'block';

    // æ–‡è¨€ã¯ã€Œå—ä»˜æ¸ˆï¼ˆæ‹…å½“è€…èª¿æ•´ä¸­ï¼‰ã€ã«å¯„ã›ã‚‹
    const title = document.querySelector('#confirmationSection h2');
    const desc = document.querySelector('#confirmationSection p');
    if (title) title.textContent = 'å—ä»˜ã—ã¾ã—ãŸ';
    if (desc) desc.textContent = 'å—ä»˜æ¸ˆï¼ˆæ‹…å½“è€…èª¿æ•´ä¸­ï¼‰ã§ã™ã€‚æ‹…å½“è€…ãŒç¢ºå®šæ¬¡ç¬¬ã€ãƒã‚¤äºˆç´„ã§ã”ç¢ºèªã„ãŸã ã‘ã¾ã™ã€‚';

    const details = document.getElementById('confirmationDetails');
    details.innerHTML = `
      <div class="detail-item">
        <div class="detail-icon"><i class="fas fa-calendar"></i></div>
        <div class="detail-content">
          <div class="detail-label">æ—¥ä»˜</div>
          <div class="detail-value">${escapeHtml(selectedGroup.date)}</div>
        </div>
      </div>
      <div class="detail-item">
        <div class="detail-icon"><i class="fas fa-clock"></i></div>
        <div class="detail-content">
          <div class="detail-label">æ™‚é–“</div>
          <div class="detail-value">${escapeHtml(selectedGroup.startTime)} - ${escapeHtml(selectedGroup.endTime)}</div>
        </div>
      </div>
      <div class="detail-item">
        <div class="detail-icon"><i class="fas fa-tag"></i></div>
        <div class="detail-content">
          <div class="detail-label">é¢è«‡ã‚¿ã‚¤ãƒ—</div>
          <div class="detail-value">${escapeHtml(selectedGroup.type)}</div>
        </div>
      </div>
      <div class="detail-item">
        <div class="detail-icon"><i class="fas fa-map-marker-alt"></i></div>
        <div class="detail-content">
          <div class="detail-label">å ´æ‰€</div>
          <div class="detail-value">${escapeHtml(selectedGroup.location)}</div>
        </div>
      </div>
      <div class="detail-item">
        <div class="detail-icon"><i class="fas fa-hourglass-half"></i></div>
        <div class="detail-content">
          <div class="detail-label">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</div>
          <div class="detail-value">å—ä»˜æ¸ˆï¼ˆæ‹…å½“è€…èª¿æ•´ä¸­ï¼‰</div>
        </div>
      </div>
    `;
  }

  // ==========================
  // Calendar navigation (global)
  // ==========================
  window.previousMonth = function() {
    if (currentMonth === 0) { currentMonth = 11; currentYear--; }
    else currentMonth--;
    renderCalendar();
  };

  window.nextMonth = function() {
    if (currentMonth === 11) { currentMonth = 0; currentYear++; }
    else currentMonth++;
    renderCalendar();
  };
</script>

</body>
</html>
