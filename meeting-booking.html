<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é¢è«‡äºˆç´„ | ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼å¸¯åŒãƒ—ãƒ­ã‚°ãƒ©ãƒ </title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2em;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .nav {
            background: #f8f9fa;
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #dee2e6;
        }

        .nav a {
            color: #667eea;
            text-decoration: none;
            padding: 8px 16px;
            border-radius: 8px;
            transition: all 0.3s;
        }

        .nav a:hover {
            background: #667eea;
            color: white;
        }

        .content {
            padding: 40px;
        }

        .steps {
            display: flex;
            justify-content: space-between;
            margin-bottom: 40px;
            position: relative;
        }

        .steps::before {
            content: '';
            position: absolute;
            top: 20px;
            left: 10%;
            right: 10%;
            height: 2px;
            background: #dee2e6;
            z-index: 0;
        }

        .step {
            flex: 1;
            text-align: center;
            position: relative;
            z-index: 1;
        }

        .step-number {
            width: 40px;
            height: 40px;
            background: #dee2e6;
            color: #6c757d;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 10px;
            font-weight: bold;
            transition: all 0.3s;
        }

        .step.active .step-number {
            background: #667eea;
            color: white;
            transform: scale(1.2);
        }

        .step.completed .step-number {
            background: #28a745;
            color: white;
        }

        .step-label {
            font-size: 0.9em;
            color: #6c757d;
        }

        .step.active .step-label {
            color: #667eea;
            font-weight: bold;
        }

        .calendar {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 10px;
            margin-top: 20px;
        }

        .calendar-header {
            text-align: center;
            font-weight: bold;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .calendar-day {
            aspect-ratio: 1;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
            background: white;
        }

        .calendar-day:hover:not(.disabled):not(.empty) {
            border-color: #667eea;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(102, 126, 234, 0.2);
        }

        .calendar-day.selected {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .calendar-day.disabled {
            background: #f8f9fa;
            color: #adb5bd;
            cursor: not-allowed;
        }

        .calendar-day.empty {
            border: none;
            cursor: default;
        }

        .calendar-day.has-slots::after {
            content: 'â—';
            color: #28a745;
            font-size: 0.8em;
            margin-top: 2px;
        }

        .calendar-day.selected.has-slots::after {
            color: white;
        }

        .slot-list {
            margin-top: 30px;
        }

        .slot-item {
            border: 2px solid #dee2e6;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            cursor: pointer;
            transition: all 0.3s;
            background: white;
        }

        .slot-item:hover {
            border-color: #667eea;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.15);
            transform: translateX(5px);
        }

        .slot-item.selected {
            border-color: #667eea;
            background: #f0f4ff;
        }

        .slot-item.full {
            background: #f8f9fa;
            border-color: #dee2e6;
            cursor: not-allowed;
            opacity: 0.6;
        }

        .slot-time {
            font-size: 1.2em;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 8px;
        }

        .slot-info {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            margin-top: 10px;
        }

        .slot-info-item {
            display: flex;
            align-items: center;
            gap: 5px;
            color: #6c757d;
        }

        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: bold;
        }

        .badge-success {
            background: #d4edda;
            color: #155724;
        }

        .badge-danger {
            background: #f8d7da;
            color: #721c24;
        }

        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: bold;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .button-group {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 30px;
        }

        .loading {
            text-align: center;
            padding: 40px;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #6c757d;
        }

        .empty-state-icon {
            font-size: 4em;
            margin-bottom: 20px;
            opacity: 0.3;
        }

        .month-nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 12px;
        }

        .month-nav button {
            background: white;
            border: 2px solid #dee2e6;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .month-nav button:hover {
            border-color: #667eea;
            color: #667eea;
        }

        .month-nav h3 {
            color: #495057;
        }

        .confirmation {
            background: #f0f4ff;
            border: 2px solid #667eea;
            border-radius: 12px;
            padding: 30px;
            margin-top: 20px;
        }

        .confirmation h3 {
            color: #667eea;
            margin-bottom: 20px;
        }

        .confirmation-details {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .confirmation-item {
            display: flex;
            padding: 10px 0;
            border-bottom: 1px solid #dee2e6;
        }

        .confirmation-item:last-child {
            border-bottom: none;
        }

        .confirmation-label {
            font-weight: bold;
            width: 120px;
            color: #495057;
        }

        .confirmation-value {
            flex: 1;
            color: #212529;
        }

        .alert {
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .alert-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .alert-warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeeba;
        }

        #step1, #step2, #step3 {
            display: none;
        }

        #step1.active, #step2.active, #step3.active {
            display: block;
        }

        @media (max-width: 768px) {
            .calendar {
                gap: 5px;
            }

            .slot-info {
                flex-direction: column;
                gap: 10px;
            }

            .button-group {
                flex-direction: column;
            }

            .steps {
                flex-direction: column;
                gap: 20px;
            }

            .steps::before {
                display: none;
            }
        }

        /* åˆæœŸãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ç”»é¢ã‚’éš ã™ */
        .initial-loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        .initial-loading.hidden {
            display: none;
        }

        .initial-loading-content {
            text-align: center;
            color: white;
        }
    </style>
</head>
<body>
    <!-- åˆæœŸãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ç”»é¢ -->
    <div class="initial-loading" id="initialLoading">
        <div class="initial-loading-content">
            <div class="spinner"></div>
            <p style="font-size: 1.2em; margin-top: 20px;">èªè¨¼æƒ…å ±ã‚’ç¢ºèªä¸­...</p>
        </div>
    </div>

    <div class="container" style="display: none;" id="mainContent">
        <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
        <div class="header">
            <h1>ğŸ“… é¢è«‡äºˆç´„</h1>
            <p>ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼å¸¯åŒãƒ—ãƒ­ã‚°ãƒ©ãƒ </p>
        </div>

        <!-- ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ -->
        <div class="nav">
            <a href="dashboard.html">â† ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã«æˆ»ã‚‹</a>
            <a href="my-meetings.html">ãƒã‚¤äºˆç´„ã‚’è¦‹ã‚‹</a>
        </div>

        <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
        <div class="content">
            <!-- ã‚¹ãƒ†ãƒƒãƒ—ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ -->
            <div class="steps">
                <div class="step active" data-step="1">
                    <div class="step-number">1</div>
                    <div class="step-label">é¢è«‡ã‚¿ã‚¤ãƒ—é¸æŠ</div>
                </div>
                <div class="step" data-step="2">
                    <div class="step-number">2</div>
                    <div class="step-label">æ—¥ç¨‹é¸æŠ</div>
                </div>
                <div class="step" data-step="3">
                    <div class="step-number">3</div>
                    <div class="step-label">ç¢ºèªãƒ»äºˆç´„</div>
                </div>
            </div>

            <!-- Step 1: é¢è«‡ã‚¿ã‚¤ãƒ—é¸æŠ -->
            <div id="step1" class="active">
                <h2 style="margin-bottom: 20px;">é¢è«‡ã‚¿ã‚¤ãƒ—ã‚’é¸æŠã—ã¦ãã ã•ã„</h2>
                <div class="alert alert-info">
                    <strong>ğŸ’¡ ãƒ’ãƒ³ãƒˆ:</strong> åˆã‚ã¦ã®æ–¹ã¯ã€Œåˆå›ã‚­ãƒ£ãƒªã‚¢é¢è«‡ã€ã‚’ãŠé¸ã³ãã ã•ã„
                </div>
                <div id="meetingTypeList" class="loading">
                    <div class="spinner"></div>
                    <p>é¢è«‡ã‚¿ã‚¤ãƒ—ã‚’èª­ã¿è¾¼ã¿ä¸­...</p>
                </div>
            </div>

            <!-- Step 2: æ—¥ç¨‹é¸æŠ -->
            <div id="step2">
                <h2 style="margin-bottom: 20px;">æ—¥ç¨‹ã‚’é¸æŠã—ã¦ãã ã•ã„</h2>
                
                <div class="month-nav">
                    <button id="prevMonth">â† å‰æœˆ</button>
                    <h3 id="currentMonth"></h3>
                    <button id="nextMonth">æ¬¡æœˆ â†’</button>
                </div>

                <div class="alert alert-info">
                    <strong>ğŸ“… ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã®è¦‹æ–¹:</strong> ç·‘ã®ç‚¹(â—)ãŒä»˜ã„ã¦ã„ã‚‹æ—¥ã«é¢è«‡æ ãŒã‚ã‚Šã¾ã™
                </div>

                <div id="calendar" class="calendar"></div>

                <div id="slotList" class="slot-list" style="display: none;">
                    <h3 style="margin-bottom: 15px;">é¸æŠã—ãŸæ—¥ã®é¢è«‡æ </h3>
                    <div id="slots"></div>
                </div>

                <div class="button-group">
                    <button class="btn btn-secondary" onclick="goToStep(1)">â† æˆ»ã‚‹</button>
                    <button class="btn btn-primary" id="nextToConfirm" disabled>ç¢ºèªç”»é¢ã¸ â†’</button>
                </div>
            </div>

            <!-- Step 3: ç¢ºèªãƒ»äºˆç´„ -->
            <div id="step3">
                <h2 style="margin-bottom: 20px;">äºˆç´„å†…å®¹ã®ç¢ºèª</h2>

                <div class="confirmation">
                    <h3>ğŸ“ äºˆç´„å†…å®¹</h3>
                    <div class="confirmation-details">
                        <div class="confirmation-item">
                            <div class="confirmation-label">é¢è«‡ã‚¿ã‚¤ãƒ—:</div>
                            <div class="confirmation-value" id="confirmType"></div>
                        </div>
                        <div class="confirmation-item">
                            <div class="confirmation-label">æ—¥æ™‚:</div>
                            <div class="confirmation-value" id="confirmDate"></div>
                        </div>
                        <div class="confirmation-item">
                            <div class="confirmation-label">å ´æ‰€:</div>
                            <div class="confirmation-value" id="confirmLocation"></div>
                        </div>
                        <div class="confirmation-item">
                            <div class="confirmation-label">æ‹…å½“è€…:</div>
                            <div class="confirmation-value">èª¿æ•´å¾Œã«ãŠçŸ¥ã‚‰ã›ã—ã¾ã™</div>
                        </div>
                    </div>

                    <div class="alert alert-warning">
                        <strong>âš ï¸ æ³¨æ„äº‹é …:</strong><br>
                        â€¢ äºˆç´„å¾Œã®ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã¯ã€Œãƒã‚¤äºˆç´„ã€ãƒšãƒ¼ã‚¸ã‹ã‚‰å¯èƒ½ã§ã™<br>
                        â€¢ é¢è«‡ã®3æ—¥å‰ã¾ã§ã«ã‚­ãƒ£ãƒ³ã‚»ãƒ«ãƒ»å¤‰æ›´ã‚’ãŠé¡˜ã„ã—ã¾ã™<br>
                        â€¢ ã‚ªãƒ³ãƒ©ã‚¤ãƒ³é¢è«‡ã®ãƒªãƒ³ã‚¯ã¯é¢è«‡å‰æ—¥ã«ãƒ¡ãƒ¼ãƒ«ã§ãŠé€ã‚Šã—ã¾ã™
                    </div>
                </div>

                <div class="button-group">
                    <button class="btn btn-secondary" onclick="goToStep(2)">â† æˆ»ã‚‹</button>
                    <button class="btn btn-primary" id="submitBooking">äºˆç´„ã‚’ç¢ºå®šã™ã‚‹</button>
                </div>

                <div id="bookingResult" style="display: none; margin-top: 20px;"></div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import {
            getFirestore,
            collection, query, where, orderBy, getDocs,
            doc, getDoc, addDoc, setDoc,
            runTransaction, increment,
            Timestamp, serverTimestamp
        } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        // Firebaseè¨­å®šï¼ˆdashboard.htmlã¨åŒã˜Configã‚’ä½¿ç”¨ï¼‰
        const firebaseConfig = {
            apiKey: "AIzaSyA6iFUhXOueccuoLJVU9ZSvXywHmj8zoR4",
            authDomain: "university-relocation-support.firebaseapp.com",
            projectId: "university-relocation-support",
            storageBucket: "university-relocation-support.firebasestorage.app",
            messagingSenderId: "849634495988",
            appId: "1:849634495988:web:013663976b0c4d6b4f7da1",
            measurementId: "G-RJP20TC7DV"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        let currentUser = null;
        let selectedType = null;
        let selectedSlot = null;
        let selectedSlotData = null;
        let currentDate = new Date();
        let availableDates = new Set();

        // èªè¨¼ãƒã‚§ãƒƒã‚¯ï¼ˆä¿®æ­£ç‰ˆï¼‰
        let authChecked = false;
        
        onAuthStateChanged(auth, (user) => {
            authChecked = true;
            
            // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ç”»é¢ã‚’éè¡¨ç¤º
            document.getElementById('initialLoading').classList.add('hidden');
            
            if (user) {
                currentUser = user;
                console.log('âœ… ãƒ­ã‚°ã‚¤ãƒ³æ¸ˆã¿:', user.email);
                
                // ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’è¡¨ç¤º
                document.getElementById('mainContent').style.display = 'block';
                
                // é¢è«‡ã‚¿ã‚¤ãƒ—ã‚’èª­ã¿è¾¼ã¿
                loadMeetingTypes();
            } else {
                console.log('âŒ æœªãƒ­ã‚°ã‚¤ãƒ³ - ãƒ­ã‚°ã‚¤ãƒ³ãƒšãƒ¼ã‚¸ã¸ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ');
                
                // 3ç§’å¾…ã£ã¦ã‹ã‚‰ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆï¼ˆèª¤æ¤œçŸ¥ã‚’é˜²ãï¼‰
                setTimeout(() => {
                    if (!currentUser) {
                        window.location.href = 'index.html';
                    }
                }, 3000);
            }
        });

        // Step 1: é¢è«‡ã‚¿ã‚¤ãƒ—èª­ã¿è¾¼ã¿
        async function loadMeetingTypes() {
            const container = document.getElementById('meetingTypeList');
            
            try {
                // meetingSlotsã‹ã‚‰åˆ©ç”¨å¯èƒ½ãªé¢è«‡ã‚¿ã‚¤ãƒ—ã‚’å–å¾—
                const slotsRef = collection(db, 'meetingSlots');
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                const todayStr = today.toISOString().split('T')[0];

                const q = query(
                    slotsRef,
                    where('date', '>=', todayStr),
                    where('status', '==', 'available'),
                    orderBy('date')
                );

                const snapshot = await getDocs(q);
                
                if (snapshot.empty) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">ğŸ“­</div>
                            <h3>ç¾åœ¨äºˆç´„å¯èƒ½ãªé¢è«‡æ ãŒã‚ã‚Šã¾ã›ã‚“</h3>
                            <p>æ–°ã—ã„é¢è«‡æ ãŒè¿½åŠ ã•ã‚Œã‚‹ã¾ã§ãŠå¾…ã¡ãã ã•ã„</p>
                        </div>
                    `;
                    return;
                }

                // ã‚¿ã‚¤ãƒ—ã”ã¨ã«é›†è¨ˆ
                const types = {};
                snapshot.forEach(doc => {
                    const data = doc.data();
                    const type = data.type || data.meetingType || 'ä¸€èˆ¬é¢è«‡';
                    
                    if (!types[type]) {
                        types[type] = {
                            count: 0,
                            description: getTypeDescription(type)
                        };
                    }
                    types[type].count++;
                });

                // HTMLç”Ÿæˆ
                let html = '<div style="display: grid; gap: 15px;">';
                
                for (const [type, info] of Object.entries(types)) {
                    html += `
                        <div class="slot-item" onclick="selectMeetingType('${type}')">
                            <div class="slot-time">${getTypeIcon(type)} ${type}</div>
                            <p style="color: #6c757d; margin: 10px 0;">${info.description}</p>
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 10px;">
                                <span class="badge badge-success">åˆ©ç”¨å¯èƒ½æ : ${info.count}ä»¶</span>
                                <span style="color: #667eea; font-weight: bold;">é¸æŠã™ã‚‹ â†’</span>
                            </div>
                        </div>
                    `;
                }
                
                html += '</div>';
                container.innerHTML = html;

            } catch (error) {
                console.error('âŒ é¢è«‡ã‚¿ã‚¤ãƒ—èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                container.innerHTML = `
                    <div class="alert alert-warning">
                        <strong>âš ï¸ ã‚¨ãƒ©ãƒ¼:</strong> é¢è«‡ã‚¿ã‚¤ãƒ—ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ<br>
                        ${error.message}
                    </div>
                `;
            }
        }

        function getTypeIcon(type) {
            const icons = {
                'åˆå›ã‚­ãƒ£ãƒªã‚¢é¢è«‡': 'ğŸ‘‹',
                'ã‚­ãƒ£ãƒªã‚¢ç›¸è«‡': 'ğŸ’¼',
                'æ±‚è·æ”¯æ´': 'ğŸ”',
                'ç”Ÿæ´»ç›¸è«‡': 'ğŸ ',
                'ãã®ä»–': 'ğŸ’¬'
            };
            return icons[type] || 'ğŸ“‹';
        }

        function getTypeDescription(type) {
            const descriptions = {
                'åˆå›ã‚­ãƒ£ãƒªã‚¢é¢è«‡': 'åˆã‚ã¦ã®æ–¹å‘ã‘ã€‚ã‚­ãƒ£ãƒªã‚¢ã®æ–¹å‘æ€§ã‚„æ”¯æ´å†…å®¹ã‚’ã”èª¬æ˜ã—ã¾ã™',
                'ã‚­ãƒ£ãƒªã‚¢ç›¸è«‡': 'ã‚­ãƒ£ãƒªã‚¢ãƒ—ãƒ©ãƒ³ã®ç›¸è«‡ã‚„ä»•äº‹æ¢ã—ã®ã‚¢ãƒ‰ãƒã‚¤ã‚¹',
                'æ±‚è·æ”¯æ´': 'æ±‚äººæƒ…å ±ã®ç´¹ä»‹ã‚„å¿œå‹Ÿæ›¸é¡ã®æ·»å‰Š',
                'ç”Ÿæ´»ç›¸è«‡': 'ç”Ÿæ´»ã«é–¢ã™ã‚‹å„ç¨®ç›¸è«‡',
                'ãã®ä»–': 'ä¸Šè¨˜ä»¥å¤–ã®ã”ç›¸è«‡'
            };
            return descriptions[type] || 'é¢è«‡ã®è©³ç´°ã¯ãŠå•ã„åˆã‚ã›ãã ã•ã„';
        }

        // æ—¥ä»˜ã‚’æ—¥æœ¬èªå½¢å¼ã«ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ (ã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³ã®å•é¡Œã‚’å›é¿)
        function formatDateJP(dateStr) {
            // dateStr ã¯ "2026-01-22" å½¢å¼
            const parts = dateStr.split('-');
            if (parts.length !== 3) return dateStr;
            
            const year = parts[0];
            const month = parseInt(parts[1], 10);
            const day = parseInt(parts[2], 10);
            
            return `${year}å¹´${month}æœˆ${day}æ—¥`;
        }

        // é¢è«‡ã‚¿ã‚¤ãƒ—é¸æŠ
        window.selectMeetingType = function(type) {
            selectedType = type;
            console.log('âœ… é¸æŠã•ã‚ŒãŸé¢è«‡ã‚¿ã‚¤ãƒ—:', type);
            goToStep(2);
            loadCalendar();
        };

        // Step 2: ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼èª­ã¿è¾¼ã¿
        async function loadCalendar() {
            try {
                // åˆ©ç”¨å¯èƒ½ãªæ—¥ä»˜ã‚’å–å¾—
                const slotsRef = collection(db, 'meetingSlots');
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                const todayStr = today.toISOString().split('T')[0];

                const q = query(
                    slotsRef,
                    where('date', '>=', todayStr),
                    where('status', '==', 'available'),
                    where('type', '==', selectedType),
                    orderBy('date')
                );

                const snapshot = await getDocs(q);
                
                availableDates = new Set();
                snapshot.forEach(doc => {
                    const data = doc.data();
                    availableDates.add(data.date);
                });

                renderCalendar();

            } catch (error) {
                console.error('âŒ ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
            }
        }

        function renderCalendar() {
            const calendar = document.getElementById('calendar');
            const monthLabel = document.getElementById('currentMonth');
            
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            
            monthLabel.textContent = `${year}å¹´ ${month + 1}æœˆ`;
            
            // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ãƒ˜ãƒƒãƒ€ãƒ¼
            const weekDays = ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'];
            let html = '';
            
            weekDays.forEach(day => {
                html += `<div class="calendar-header">${day}</div>`;
            });
            
            // æœˆåˆã®æ›œæ—¥
            const firstDay = new Date(year, month, 1).getDay();
            const lastDate = new Date(year, month + 1, 0).getDate();
            
            // ç©ºç™½ã‚»ãƒ«
            for (let i = 0; i < firstDay; i++) {
                html += '<div class="calendar-day empty"></div>';
            }
            
            // æ—¥ä»˜ã‚»ãƒ«
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            for (let date = 1; date <= lastDate; date++) {
                const currentDateObj = new Date(year, month, date);
                // âœ… ä¿®æ­£: ã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³ã®å•é¡Œã‚’å›é¼ã™ã‚‹ãŸã‚ã€ç›´æ¥æ–‡å­—åˆ—ã‚’ä½œæˆ
                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(date).padStart(2, '0')}`;
                
                const isPast = currentDateObj < today;
                const hasSlots = availableDates.has(dateStr);
                
                let className = 'calendar-day';
                if (isPast) className += ' disabled';
                if (hasSlots && !isPast) className += ' has-slots';
                
                const onclick = (hasSlots && !isPast) ? `onclick="selectDate('${dateStr}')"` : '';
                
                html += `
                    <div class="${className}" ${onclick}>
                        <div style="font-size: 1.2em;">${date}</div>
                    </div>
                `;
            }
            
            calendar.innerHTML = html;
        }

        // æ—¥ä»˜é¸æŠ
        window.selectDate = async function(dateStr) {
            console.log('âœ… é¸æŠã•ã‚ŒãŸæ—¥ä»˜:', dateStr);
            
            // é¸æŠçŠ¶æ…‹ã‚’æ›´æ–°
            document.querySelectorAll('.calendar-day').forEach(day => {
                day.classList.remove('selected');
            });
            event.currentTarget.classList.add('selected');
            
            // ãã®æ—¥ã®é¢è«‡æ ã‚’è¡¨ç¤º
            await loadSlotsForDate(dateStr);
        };

        async function loadSlotsForDate(dateStr) {
            const slotListContainer = document.getElementById('slotList');
            const slotsContainer = document.getElementById('slots');
            
            slotListContainer.style.display = 'block';
            slotsContainer.innerHTML = '<div class="loading"><div class="spinner"></div><p>é¢è«‡æ ã‚’èª­ã¿è¾¼ã¿ä¸­...</p></div>';
            
            try {
                const slotsRef = collection(db, 'meetingSlots');
                const q = query(
                    slotsRef,
                    where('date', '==', dateStr),
                    where('status', '==', 'available'),
                    where('type', '==', selectedType),
                    orderBy('startTime')
                );

                const snapshot = await getDocs(q);
                
                if (snapshot.empty) {
                    slotsContainer.innerHTML = `
                        <div class="empty-state">
                            <p>ã“ã®æ—¥ã¯ç©ºããŒã‚ã‚Šã¾ã›ã‚“</p>
                        </div>
                    `;
                    return;
                }

                let html = '';
                snapshot.forEach(doc => {
                    const data = doc.data();
                    const slotId = doc.id;
                    
                    const available = (data.currentBookings || 0) < (data.maxCapacity || 1);
                    const availableClass = available ? '' : 'full';
                    const onclick = available ? `onclick="selectSlot('${slotId}')"` : '';
                    
                    html += `
                        <div class="slot-item ${availableClass}" ${onclick} data-slot-id="${slotId}">
                            <div class="slot-time">${data.startTime} - ${data.endTime}</div>
                            <div class="slot-info">
                                <div class="slot-info-item">
                                    <span>ğŸ“</span>
                                    <span>${data.location || 'ã‚ªãƒ³ãƒ©ã‚¤ãƒ³'}</span>
                                </div>
                                <div class="slot-info-item">
                                    <span>ğŸ‘¥</span>
                                    <span>å®šå“¡: ${data.maxCapacity || 1}å</span>
                                </div>
                                <div class="slot-info-item">
                                    <span>äºˆç´„çŠ¶æ³: ${data.currentBookings || 0}/${data.maxCapacity || 1}</span>
                                </div>
                            </div>
                            ${available ? 
                                '<span class="badge badge-success">ç©ºãã‚ã‚Š</span>' : 
                                '<span class="badge badge-danger">æº€å¸­</span>'
                            }
                        </div>
                    `;
                });
                
                slotsContainer.innerHTML = html;

            } catch (error) {
                console.error('âŒ é¢è«‡æ èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                slotsContainer.innerHTML = `
                    <div class="alert alert-warning">
                        <strong>âš ï¸ ã‚¨ãƒ©ãƒ¼:</strong> é¢è«‡æ ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ
                    </div>
                `;
            }
        }

        // é¢è«‡æ é¸æŠ
        window.selectSlot = async function(slotId) {
            console.log('âœ… é¸æŠã•ã‚ŒãŸé¢è«‡æ :', slotId);
            
            // é¸æŠçŠ¶æ…‹ã‚’æ›´æ–°
            document.querySelectorAll('.slot-item').forEach(item => {
                item.classList.remove('selected');
            });
            event.currentTarget.classList.add('selected');
            
            selectedSlot = slotId;
            
            // é¢è«‡æ ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
            try {
                const slotDoc = await getDoc(doc(db, 'meetingSlots', slotId));
                if (slotDoc.exists()) {
                    selectedSlotData = slotDoc.data();
                    document.getElementById('nextToConfirm').disabled = false;
                }
            } catch (error) {
                console.error('âŒ é¢è«‡æ ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
            }
        };

        // ç¢ºèªç”»é¢ã¸
        document.getElementById('nextToConfirm').addEventListener('click', function() {
            if (!selectedSlot || !selectedSlotData) {
                alert('é¢è«‡æ ã‚’é¸æŠã—ã¦ãã ã•ã„');
                return;
            }
            
            // ç¢ºèªç”»é¢ã«æƒ…å ±ã‚’è¡¨ç¤º
            document.getElementById('confirmType').textContent = selectedType;
            document.getElementById('confirmDate').textContent = 
                `${formatDateJP(selectedSlotData.date)} ${selectedSlotData.startTime} - ${selectedSlotData.endTime}`;
            document.getElementById('confirmLocation').textContent = selectedSlotData.location || 'ã‚ªãƒ³ãƒ©ã‚¤ãƒ³';
            
            goToStep(3);
        });

        // äºˆç´„ç¢ºå®š
        document.getElementById('submitBooking').addEventListener('click', async function() {
            const button = this;
            const resultDiv = document.getElementById('bookingResult');
            
            button.disabled = true;
            button.textContent = 'äºˆç´„å‡¦ç†ä¸­...';
            resultDiv.style.display = 'none';
            
            try {
                // ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã§äºˆç´„ä½œæˆã¨é¢è«‡æ æ›´æ–°ã‚’åŒæ™‚å®Ÿè¡Œ
                await runTransaction(db, async (transaction) => {
                    // é¢è«‡æ ã‚’å–å¾—
                    const slotRef = doc(db, 'meetingSlots', selectedSlot);
                    const slotDoc = await transaction.get(slotRef);
                    
                    if (!slotDoc.exists()) {
                        throw new Error('é¢è«‡æ ãŒå­˜åœ¨ã—ã¾ã›ã‚“');
                    }
                    
                    const slotData = slotDoc.data();
                    const currentBookings = slotData.currentBookings || 0;
                    const maxCapacity = slotData.maxCapacity || 1;
                    
                    // ç©ºããŒã‚ã‚‹ã‹ç¢ºèª
                    if (currentBookings >= maxCapacity) {
                        throw new Error('æº€å¸­ã§ã™');
                    }
                    
                    // äºˆç´„ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’ä½œæˆ
                    const meetingRef = doc(collection(db, 'meetingRequests'));
                    transaction.set(meetingRef, {
                        userId: currentUser.uid,
                        userName: currentUser.displayName || currentUser.email,
                        userEmail: currentUser.email,
                        slotId: selectedSlot,
                        meetingType: selectedType,
                        requestedType: selectedType,  // my-meetings.html ãŒæœŸå¾…ã™ã‚‹ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰
                        slotDate: slotData.date,
                        date: slotData.date,  // my-meetings.html ãŒæœŸå¾…ã™ã‚‹ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰
                        slotStartTime: slotData.startTime,
                        startTime: slotData.startTime,  // my-meetings.html ãŒæœŸå¾…ã™ã‚‹ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰
                        slotEndTime: slotData.endTime,
                        endTime: slotData.endTime,  // my-meetings.html ãŒæœŸå¾…ã™ã‚‹ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰
                        location: slotData.location || 'ã‚ªãƒ³ãƒ©ã‚¤ãƒ³',
                        status: 'requested',
                        // createdAt: serverTimestamp(),
                        requestedAt: serverTimestamp()  // my-meetings.html ãŒæœŸå¾…ã™ã‚‹ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰
                    });
                    
                    // é¢è«‡æ ã®äºˆç´„æ•°ã‚’æ›´æ–°
                    const newBookings = currentBookings + 1;
                    const updateData = {
                        currentBookings: increment(1)
                    };
                    
                    // æº€å¸­ã«ãªã£ãŸå ´åˆã¯statusã‚’æ›´æ–°
                    if (newBookings >= maxCapacity) {
                        updateData.status = 'full';
                    }
                    
                    transaction.update(slotRef, updateData);
                });
                
                // æˆåŠŸ
                resultDiv.innerHTML = `
                    <div style="background: #d4edda; border: 2px solid #28a745; border-radius: 12px; padding: 30px; text-align: center;">
                        <div style="font-size: 3em; margin-bottom: 20px;">âœ…</div>
                        <h3 style="color: #155724; margin-bottom: 15px;">äºˆç´„ãŒå®Œäº†ã—ã¾ã—ãŸï¼</h3>
                        <p style="color: #155724; margin-bottom: 20px;">
                            äºˆç´„å†…å®¹ã®è©³ç´°ã¯ãƒ¡ãƒ¼ãƒ«ã§ãŠé€ã‚Šã—ã¾ã™<br>
                            ã€Œãƒã‚¤äºˆç´„ã€ãƒšãƒ¼ã‚¸ã‹ã‚‰äºˆç´„å†…å®¹ã‚’ç¢ºèªã§ãã¾ã™
                        </p>
                        <div style="display: flex; gap: 15px; justify-content: center; flex-wrap: wrap;">
                            <a href="my-meetings.html" class="btn btn-primary">ãƒã‚¤äºˆç´„ã‚’è¦‹ã‚‹</a>
                            <a href="dashboard.html" class="btn btn-secondary">ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã¸</a>
                        </div>
                    </div>
                `;
                resultDiv.style.display = 'block';
                
                button.style.display = 'none';
                
            } catch (error) {
                console.error('âŒ äºˆç´„å¤±æ•—:', error);
                
                let errorMessage = 'äºˆç´„ã«å¤±æ•—ã—ã¾ã—ãŸã€‚';
                if (error.message && error.message.includes('æº€å¸­')) {
                    errorMessage = 'ã“ã®é¢è«‡æ ã¯æº€å¸­ã§ã™ã€‚åˆ¥ã®æ—¥æ™‚ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚';
                } else if (error.message && error.message.includes('å­˜åœ¨ã—ã¾ã›ã‚“')) {
                    errorMessage = 'é¢è«‡æ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚';
                } else {
                    errorMessage = 'ã‚¨ãƒ©ãƒ¼: ' + error.message;
                }
                
                resultDiv.innerHTML = `
                    <div class="alert alert-warning">
                        <strong>âš ï¸ ${errorMessage}</strong>
                    </div>
                `;
                resultDiv.style.display = 'block';
                
                button.disabled = false;
                button.textContent = 'äºˆç´„ã‚’ç¢ºå®šã™ã‚‹';
            }
        });

        // æœˆç§»å‹•
        document.getElementById('prevMonth').addEventListener('click', function() {
            currentDate.setMonth(currentDate.getMonth() - 1);
            renderCalendar();
        });

        document.getElementById('nextMonth').addEventListener('click', function() {
            currentDate.setMonth(currentDate.getMonth() + 1);
            renderCalendar();
        });

        // ã‚¹ãƒ†ãƒƒãƒ—ç§»å‹•
        window.goToStep = function(stepNumber) {
            // ã™ã¹ã¦ã®ã‚¹ãƒ†ãƒƒãƒ—ã‚’éè¡¨ç¤º
            document.querySelectorAll('#step1, #step2, #step3').forEach(step => {
                step.classList.remove('active');
            });
            
            // é¸æŠã•ã‚ŒãŸã‚¹ãƒ†ãƒƒãƒ—ã‚’è¡¨ç¤º
            document.getElementById(`step${stepNumber}`).classList.add('active');
            
            // ã‚¹ãƒ†ãƒƒãƒ—ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ã‚’æ›´æ–°
            document.querySelectorAll('.step').forEach((step, index) => {
                step.classList.remove('active', 'completed');
                if (index + 1 < stepNumber) {
                    step.classList.add('completed');
                } else if (index + 1 === stepNumber) {
                    step.classList.add('active');
                }
            });
            
            // ãƒšãƒ¼ã‚¸ãƒˆãƒƒãƒ—ã«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
            window.scrollTo({ top: 0, behavior: 'smooth' });
        };

    </script>
</body>
</html>
