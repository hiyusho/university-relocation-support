<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>登録者情報管理 - 管理画面</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #2563eb;
            --secondary-color: #1e40af;
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --danger-color: #ef4444;
            --bg-color: #f3f4f6;
            --text-color: #1f2937;
            --border-color: #e5e7eb;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Noto Sans JP', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 30px 0;
            margin-bottom: 30px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        header h1 {
            font-size: 28px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .security-banner {
            background: #10b981;
            color: white;
            padding: 12px;
            text-align: center;
            font-weight: 500;
            margin-bottom: 20px;
            border-radius: 8px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .stat-icon {
            width: 50px;
            height: 50px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }

        .stat-icon.primary { background: #dbeafe; color: var(--primary-color); }
        .stat-icon.warning { background: #fef3c7; color: var(--warning-color); }
        .stat-icon.success { background: #d1fae5; color: var(--success-color); }
        .stat-icon.danger { background: #fee2e2; color: var(--danger-color); }

        .stat-info h3 {
            font-size: 14px;
            color: #6b7280;
            margin-bottom: 5px;
        }

        .stat-info p {
            font-size: 28px;
            font-weight: 700;
        }

        .controls {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        .control-row {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: center;
        }

        .control-group {
            flex: 1;
            min-width: 200px;
        }

        .control-group label {
            display: block;
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 5px;
            color: #374151;
        }

        .control-group input,
        .control-group select {
            width: 100%;
            padding: 10px 12px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s;
        }

        .control-group input:focus,
        .control-group select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background: var(--secondary-color);
        }

        .btn-success {
            background: var(--success-color);
            color: white;
        }

        .btn-success:hover {
            background: #059669;
        }

        table {
            width: 100%;
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        thead {
            background: var(--primary-color);
            color: white;
        }

        th {
            padding: 15px;
            text-align: left;
            font-weight: 600;
            font-size: 14px;
        }

        td {
            padding: 15px;
            border-bottom: 1px solid var(--border-color);
            font-size: 14px;
        }

        tr:hover {
            background: #f9fafb;
        }

        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
        }

        .status-pending { background: #fef3c7; color: #92400e; }
        .status-processing { background: #dbeafe; color: #1e40af; }
        .status-matched { background: #d1fae5; color: #065f46; }
        .status-closed { background: #f3f4f6; color: #374151; }

        .loading {
            text-align: center;
            padding: 60px 20px;
            color: #6b7280;
        }

        .loading i {
            font-size: 48px;
            margin-bottom: 15px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            overflow-y: auto;
        }

        .modal-content {
            background: white;
            max-width: 800px;
            margin: 50px auto;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
        }

        .modal-header {
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h2 {
            font-size: 20px;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #6b7280;
        }

        .close-btn:hover {
            color: var(--text-color);
        }

        .modal-body {
            padding: 20px;
        }

        .detail-section {
            margin-bottom: 25px;
        }

        .detail-section h3 {
            font-size: 16px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--primary-color);
        }

        .detail-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .detail-item {
            padding: 10px;
            background: #f9fafb;
            border-radius: 8px;
        }

        .detail-label {
            font-size: 12px;
            color: #6b7280;
            margin-bottom: 5px;
        }

        .detail-value {
            font-size: 14px;
            font-weight: 500;
            color: var(--text-color);
        }

        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            margin-top: 20px;
            padding: 20px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .pagination button {
            padding: 8px 16px;
            border: 1px solid var(--border-color);
            background: white;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .pagination button:hover:not(:disabled) {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        .pagination button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .control-row {
                flex-direction: column;
            }

            table {
                font-size: 12px;
            }

            th, td {
                padding: 10px;
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <h1>
                <i class="fas fa-users-cog"></i>
                登録者情報管理
            </h1>
        </div>
    </header>

    <div class="container">
        <div class="security-banner">
            <i class="fas fa-shield-alt"></i>
            管理画面 - Airtable データベース接続中
        </div>

        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon primary">
                    <i class="fas fa-users"></i>
                </div>
                <div class="stat-info">
                    <h3>総登録者数</h3>
                    <p id="totalCount">0</p>
                </div>
            </div>

            <div class="stat-card">
                <div class="stat-icon warning">
                    <i class="fas fa-clock"></i>
                </div>
                <div class="stat-info">
                    <h3>未対応</h3>
                    <p id="pendingCount">0</p>
                </div>
            </div>

            <div class="stat-card">
                <div class="stat-icon primary">
                    <i class="fas fa-user-check"></i>
                </div>
                <div class="stat-info">
                    <h3>対応中</h3>
                    <p id="processingCount">0</p>
                </div>
            </div>

            <div class="stat-card">
                <div class="stat-icon success">
                    <i class="fas fa-check-circle"></i>
                </div>
                <div class="stat-info">
                    <h3>マッチング済</h3>
                    <p id="matchedCount">0</p>
                </div>
            </div>
        </div>

        <div class="controls">
            <div class="control-row">
                <div class="control-group">
                    <label for="searchInput">検索</label>
                    <input type="text" id="searchInput" placeholder="氏名、メールアドレスで検索" onkeyup="applyFilters()">
                </div>

                <div class="control-group">
                    <label for="statusFilter">ステータス</label>
                    <select id="statusFilter" onchange="applyFilters()">
                        <option value="">すべて</option>
                        <option value="未対応">未対応</option>
                        <option value="対応中">対応中</option>
                        <option value="候補紹介中">候補紹介中</option>
                        <option value="マッチング済">マッチング済</option>
                        <option value="クローズ">クローズ</option>
                    </select>
                </div>

                <div class="control-group">
                    <label>&nbsp;</label>
                    <button class="btn btn-primary" onclick="resetFilters()">
                        <i class="fas fa-sync-alt"></i> リセット
                    </button>
                </div>

                <div class="control-group">
                    <label>&nbsp;</label>
                    <button class="btn btn-success" onclick="exportData()">
                        <i class="fas fa-download"></i> CSV出力
                    </button>
                </div>
            </div>
        </div>

        <div id="loadingIndicator" class="loading">
            <i class="fas fa-spinner"></i>
            <p>データを読み込んでいます...</p>
        </div>

        <table id="registrationsTable" style="display: none;">
            <thead>
                <tr>
                    <th>登録日時</th>
                    <th>氏名</th>
                    <th>メール</th>
                    <th>年代</th>
                    <th>大学</th>
                    <th>働き方</th>
                    <th>ステータス</th>
                    <th>操作</th>
                </tr>
            </thead>
            <tbody id="tableBody">
            </tbody>
        </table>

        <div id="pagination" class="pagination" style="display: none;">
            <button onclick="changePage(-1)" id="prevBtn">
                <i class="fas fa-chevron-left"></i> 前へ
            </button>
            <span id="pageInfo">1 / 1 ページ</span>
            <button onclick="changePage(1)" id="nextBtn">
                次へ <i class="fas fa-chevron-right"></i>
            </button>
        </div>
    </div>

    <div id="detailModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2><i class="fas fa-user-circle"></i> 登録者詳細</h2>
                <button class="close-btn" onclick="closeModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body" id="modalBody">
            </div>
        </div>
    </div>

    <script>
        const AIRTABLE_API_TOKEN = 'patOnPRhiWIQ8HcU5.c40ccad44380653ebe386635bf7a5ac785acec43bf43a5dabd93f005dcbb6a36';
        const AIRTABLE_BASE_ID = 'appb0XRjUEQ8gxO3V';
        const AIRTABLE_TABLE_NAME = 'registrations';

        let allRegistrations = [];
        let filteredRegistrations = [];
        let currentPage = 1;
        const itemsPerPage = 20;

        document.addEventListener('DOMContentLoaded', async function() {
            await loadRegistrations();
        });

        async function loadRegistrations() {
            try {
                const response = await fetch(`https://api.airtable.com/v0/${AIRTABLE_BASE_ID}/${AIRTABLE_TABLE_NAME}`, {
                    headers: {
                        'Authorization': `Bearer ${AIRTABLE_API_TOKEN}`
                    }
                });
                
                if (!response.ok) {
                    throw new Error('データの取得に失敗しました');
                }

                const result = await response.json();
                allRegistrations = result.records.map(record => ({
                    id: record.id,
                    fullName: record.fields.fullName || '',
                    furigana: record.fields.furigana || '',
                    email: record.fields.email || '',
                    ageRange: record.fields.ageRange || '',
                    university: record.fields.university || '',
                    workStyle: record.fields.workStyle || '',
                    jobTypes: record.fields.jobTypes || '',
                    skills: record.fields.skills || '',
                    purposes: record.fields.purposes || '',
                    notes: record.fields.notes || '',
                    status: record.fields.status || '未対応',
                    registeredAt: record.fields.registeredAt || record.createdTime
                }));
                filteredRegistrations = [...allRegistrations];

                updateStatistics();
                renderTable();

                document.getElementById('loadingIndicator').style.display = 'none';
                document.getElementById('registrationsTable').style.display = 'table';
                document.getElementById('pagination').style.display = 'flex';

            } catch (error) {
                console.error('データ読み込みエラー:', error);
                document.getElementById('loadingIndicator').innerHTML = `
                    <i class="fas fa-exclamation-triangle" style="color: var(--danger-color);"></i>
                    <p>データの読み込みに失敗しました。</p>
                    <p style="font-size: 14px; margin-top: 10px;">エラー詳細: ${error.message}</p>
                    <button class="btn btn-primary" onclick="location.reload()">再読み込み</button>
                `;
            }
        }

        function updateStatistics() {
            const total = allRegistrations.length;
            const pending = allRegistrations.filter(r => r.status === '未対応').length;
            const processing = allRegistrations.filter(r => r.status === '対応中' || r.status === '候補紹介中').length;
            const matched = allRegistrations.filter(r => r.status === 'マッチング済').length;

            document.getElementById('totalCount').textContent = total;
            document.getElementById('pendingCount').textContent = pending;
            document.getElementById('processingCount').textContent = processing;
            document.getElementById('matchedCount').textContent = matched;
        }

        function renderTable() {
            const start = (currentPage - 1) * itemsPerPage;
            const end = start + itemsPerPage;
            const pageData = filteredRegistrations.slice(start, end);

            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '';

            if (pageData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 40px; color: #6b7280;">該当するデータがありません</td></tr>';
                updatePagination();
                return;
            }

            pageData.forEach(registration => {
                const tr = document.createElement('tr');
                const date = new Date(registration.registeredAt).toLocaleString('ja-JP');
                
                tr.innerHTML = `
                    <td>${date}</td>
                    <td>${escapeHtml(registration.fullName)}</td>
                    <td>${escapeHtml(registration.email)}</td>
                    <td>${escapeHtml(registration.ageRange)}</td>
                    <td>${escapeHtml(registration.university)}</td>
                    <td>${escapeHtml(registration.workStyle)}</td>
                    <td><span class="status-badge ${getStatusClass(registration.status)}">${escapeHtml(registration.status)}</span></td>
                    <td>
                        <button class="btn btn-primary" onclick='showDetail(${JSON.stringify(registration).replace(/'/g, "&#39;")})' style="padding: 6px 12px; font-size: 12px;">
                            <i class="fas fa-eye"></i> 詳細
                        </button>
                    </td>
                `;
                tbody.appendChild(tr);
            });

            updatePagination();
        }

        function getStatusClass(status) {
            const statusMap = {
                '未対応': 'status-pending',
                '対応中': 'status-processing',
                '候補紹介中': 'status-processing',
                'マッチング済': 'status-matched',
                'クローズ': 'status-closed'
            };
            return statusMap[status] || 'status-pending';
        }

        function applyFilters() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const statusFilter = document.getElementById('statusFilter').value;

            filteredRegistrations = allRegistrations.filter(r => {
                const matchSearch = !searchTerm || 
                    r.fullName.toLowerCase().includes(searchTerm) ||
                    r.email.toLowerCase().includes(searchTerm);
                
                const matchStatus = !statusFilter || r.status === statusFilter;

                return matchSearch && matchStatus;
            });

            currentPage = 1;
            renderTable();
        }

        function resetFilters() {
            document.getElementById('searchInput').value = '';
            document.getElementById('statusFilter').value = '';
            filteredRegistrations = [...allRegistrations];
            currentPage = 1;
            renderTable();
        }

        function updatePagination() {
            const totalPages = Math.ceil(filteredRegistrations.length / itemsPerPage);
            document.getElementById('pageInfo').textContent = `${currentPage} / ${totalPages} ページ (全${filteredRegistrations.length}件)`;
            document.getElementById('prevBtn').disabled = currentPage === 1;
            document.getElementById('nextBtn').disabled = currentPage === totalPages || totalPages === 0;
        }

        function changePage(delta) {
            const totalPages = Math.ceil(filteredRegistrations.length / itemsPerPage);
            const newPage = currentPage + delta;
            
            if (newPage >= 1 && newPage <= totalPages) {
                currentPage = newPage;
                renderTable();
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
        }

        function showDetail(registration) {
            const modal = document.getElementById('detailModal');
            const modalBody = document.getElementById('modalBody');
            
            modalBody.innerHTML = `
                <div class="detail-section">
                    <h3><i class="fas fa-user"></i> 基本情報</h3>
                    <div class="detail-grid">
                        <div class="detail-item">
                            <div class="detail-label">氏名</div>
                            <div class="detail-value">${escapeHtml(registration.fullName)}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">フリガナ</div>
                            <div class="detail-value">${escapeHtml(registration.furigana)}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">メールアドレス</div>
                            <div class="detail-value">${escapeHtml(registration.email)}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">年代</div>
                            <div class="detail-value">${escapeHtml(registration.ageRange)}</div>
                        </div>
                    </div>
                </div>

                <div class="detail-section">
                    <h3><i class="fas fa-briefcase"></i> 勤務先・希望情報</h3>
                    <div class="detail-grid">
                        <div class="detail-item">
                            <div class="detail-label">勤務先大学名</div>
                            <div class="detail-value">${escapeHtml(registration.university)}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">希望の働き方</div>
                            <div class="detail-value">${escapeHtml(registration.workStyle)}</div>
                        </div>
                        <div class="detail-item" style="grid-column: 1 / -1;">
                            <div class="detail-label">希望職種</div>
                            <div class="detail-value">${escapeHtml(registration.jobTypes || '未入力')}</div>
                        </div>
                    </div>
                </div>

                <div class="detail-section">
                    <h3><i class="fas fa-star"></i> スキル・経験</h3>
                    <div class="detail-item">
                        <div class="detail-label">経験・スキル</div>
                        <div class="detail-value">${escapeHtml(registration.skills || '未入力').replace(/\n/g, '<br>')}</div>
                    </div>
                </div>

                <div class="detail-section">
                    <h3><i class="fas fa-bullseye"></i> 登録の目的</h3>
                    <div class="detail-item">
                        <div class="detail-value">${escapeHtml(registration.purposes || '未入力')}</div>
                    </div>
                </div>

                ${registration.notes ? `
                <div class="detail-section">
                    <h3><i class="fas fa-comment"></i> 自由記述</h3>
                    <div class="detail-item">
                        <div class="detail-value">${escapeHtml(registration.notes).replace(/\n/g, '<br>')}</div>
                    </div>
                </div>
                ` : ''}

                <div class="detail-section" style="background: var(--bg-color); padding: 20px; border-radius: 8px;">
                    <h3><i class="fas fa-edit"></i> ステータス変更</h3>
                    <div style="display: flex; gap: 15px; align-items: flex-end;">
                        <div class="control-group" style="flex: 1;">
                            <label for="statusUpdate">新しいステータス</label>
                            <select id="statusUpdate">
                                <option value="未対応" ${registration.status === '未対応' ? 'selected' : ''}>未対応</option>
                                <option value="対応中" ${registration.status === '対応中' ? 'selected' : ''}>対応中</option>
                                <option value="候補紹介中" ${registration.status === '候補紹介中' ? 'selected' : ''}>候補紹介中</option>
                                <option value="マッチング済" ${registration.status === 'マッチング済' ? 'selected' : ''}>マッチング済</option>
                                <option value="クローズ" ${registration.status === 'クローズ' ? 'selected' : ''}>クローズ</option>
                            </select>
                        </div>
                        <button class="btn btn-primary" onclick="updateStatus('${registration.id}')">
                            <i class="fas fa-save"></i> 更新
                        </button>
                    </div>
                </div>
            `;
            
            modal.style.display = 'block';
            document.body.style.overflow = 'hidden';
        }

        function closeModal() {
            document.getElementById('detailModal').style.display = 'none';
            document.body.style.overflow = 'auto';
        }

        window.onclick = function(event) {
            const modal = document.getElementById('detailModal');
            if (event.target === modal) {
                closeModal();
            }
        }

        async function updateStatus(id) {
            const newStatus = document.getElementById('statusUpdate').value;
            
            try {
                const response = await fetch(`https://api.airtable.com/v0/${AIRTABLE_BASE_ID}/${AIRTABLE_TABLE_NAME}/${id}`, {
                    method: 'PATCH',
                    headers: {
                        'Authorization': `Bearer ${AIRTABLE_API_TOKEN}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        fields: {
                            status: newStatus
                        }
                    })
                });

                if (!response.ok) {
                    throw new Error('更新に失敗しました');
                }

                const index = allRegistrations.findIndex(r => r.id === id);
                if (index !== -1) {
                    allRegistrations[index].status = newStatus;
                }

                updateStatistics();
                applyFilters();
                closeModal();

                alert('✅ ステータスを更新しました');

            } catch (error) {
                console.error('更新エラー:', error);
                alert('⚠️ ステータスの更新に失敗しました\n\nエラー詳細: ' + error.message);
            }
        }

        function exportData() {
            if (filteredRegistrations.length === 0) {
                alert('エクスポートするデータがありません');
                return;
            }

            const headers = ['登録日時', '氏名', 'フリガナ', 'メールアドレス', '年代', '勤務先大学', '希望の働き方', '希望職種', '経験・スキル', '登録の目的', '自由記述', 'ステータス'];
            const rows = filteredRegistrations.map(r => {
                const date = new Date(r.registeredAt).toLocaleString('ja-JP');
                return [
                    `"${date}"`,
                    `"${r.fullName}"`,
                    `"${r.furigana}"`,
                    `"${r.email}"`,
                    `"${r.ageRange}"`,
                    `"${r.university}"`,
                    `"${r.workStyle}"`,
                    `"${r.jobTypes}"`,
                    `"${r.skills}"`,
                    `"${r.purposes}"`,
                    `"${r.notes}"`,
                    `"${r.status}"`
                ].join(',');
            });

            const csv = '\uFEFF' + [headers.join(','), ...rows].join('\n');
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            
            link.setAttribute('href', url);
            link.setAttribute('download', `registrations_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>
</body>
</html>

