<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒã‚¤ãƒšãƒ¼ã‚¸ | å¤§å­¦èµ´ä»»è€…ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼å¸¯åŒãƒ—ãƒ­ã‚°ãƒ©ãƒ </title>
    <meta name="description" content="å¤§å­¦èµ´ä»»è€…ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼å¸¯åŒãƒ—ãƒ­ã‚°ãƒ©ãƒ ã®ãƒã‚¤ãƒšãƒ¼ã‚¸ã€‚é¢è«‡äºˆç´„ç®¡ç†ã€ä¼æ¥­ç´¹ä»‹ã€å¿œå‹Ÿæ›¸é¡ç®¡ç†ãªã©ã‚’ä¸€å…ƒç®¡ç†ã§ãã¾ã™ã€‚">
    <meta name="keywords" content="ãƒã‚¤ãƒšãƒ¼ã‚¸,ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰,é¢è«‡äºˆç´„,ä¼æ¥­ç´¹ä»‹,å¿œå‹Ÿæ›¸é¡,ã‚­ãƒ£ãƒªã‚¢æ”¯æ´">
    <meta name="author" content="å¤§å­¦èµ´ä»»è€…ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼å¸¯åŒãƒ—ãƒ­ã‚°ãƒ©ãƒ ">
    <meta name="robots" content="noindex, nofollow">

    <!-- OGP -->
    <meta property="og:type" content="website">
    <meta property="og:title" content="ãƒã‚¤ãƒšãƒ¼ã‚¸ | å¤§å­¦èµ´ä»»è€…ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼å¸¯åŒãƒ—ãƒ­ã‚°ãƒ©ãƒ ">
    <meta property="og:description" content="ã‚ãªãŸå°‚ç”¨ã®ãƒã‚¤ãƒšãƒ¼ã‚¸ã§ã€é¢è«‡äºˆç´„ã‚„å¿œå‹ŸçŠ¶æ³ã‚’ä¸€å…ƒç®¡ç†ã§ãã¾ã™ã€‚">
    <meta property="og:url" content="https://hiyusho.github.io/university-relocation-support/dashboard.html">

    <!-- Canonical URL -->
    <link rel="canonical" href="https://hiyusho.github.io/university-relocation-support/dashboard.html">

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Hiragino Kaku Gothic ProN',
                         'Hiragino Sans', Meiryo, sans-serif;
            background: #f5f7fa;
            min-height: 100vh;
        }

        /* ãƒ˜ãƒƒãƒ€ãƒ¼ */
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 0;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .logo {
            font-size: 1.2rem;
            font-weight: 700;
            text-decoration: none;
            color: white;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .logo i { font-size: 1.5rem; }

        .header-right {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 0.95rem;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: white;
            color: #667eea;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 1.1rem;
        }

        .logout-btn {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
            padding: 8px 20px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .logout-btn:hover { background: rgba(255, 255, 255, 0.3); }

        /* ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒŠ */
        .main-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 30px 20px;
            display: grid;
            grid-template-columns: 250px 1fr;
            gap: 30px;
        }

        /* ã‚µã‚¤ãƒ‰ãƒãƒ¼ */
        .sidebar {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            height: fit-content;
            position: sticky;
            top: 90px;
        }

        .sidebar-title {
            font-size: 1rem;
            font-weight: 700;
            color: #333;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }

        .sidebar-menu { list-style: none; }
        .sidebar-menu li { margin-bottom: 5px; }

        .sidebar-menu a {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 15px;
            color: #666;
            text-decoration: none;
            border-radius: 10px;
            transition: all 0.3s ease;
            font-size: 0.95rem;
        }

        .sidebar-menu a:hover { background: #f8f9fa; color: #667eea; }

        .sidebar-menu a.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .sidebar-menu i {
            font-size: 1.1rem;
            width: 20px;
            text-align: center;
        }

        /* ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚¨ãƒªã‚¢ */
        .content {
            display: flex;
            flex-direction: column;
            gap: 25px;
        }

        /* ã‚¦ã‚§ãƒ«ã‚«ãƒ ã‚«ãƒ¼ãƒ‰ */
        .welcome-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.3);
        }

        .welcome-card h1 { font-size: 1.8rem; margin-bottom: 10px; }
        .welcome-card p { font-size: 0.95rem; opacity: 0.9; }

        /* ã‚«ãƒ¼ãƒ‰ã‚°ãƒªãƒƒãƒ‰ */
        .card-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease;
        }

        .card:hover {
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
            transform: translateY(-3px);
        }

        .card-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }

        .card-icon {
            width: 45px;
            height: 45px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.3rem;
            color: white;
        }

        .card-icon.schedule { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .card-icon.message { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); }
        .card-icon.company { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); }
        .card-icon.document { background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); }
        .card-icon.stats { background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); }

        .card-title { font-size: 1.1rem; font-weight: 700; color: #333; }

        .card-count {
            background: #e3f2fd;
            color: #1976D2;
            font-size: 0.8rem;
            padding: 3px 10px;
            border-radius: 12px;
            font-weight: 600;
            margin-left: auto;
        }

        /* äºˆå®šã‚«ãƒ¼ãƒ‰ */
        .schedule-item {
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
            margin-bottom: 15px;
        }
        .schedule-item:last-child { margin-bottom: 0; }
        .schedule-date { font-size: 0.85rem; color: #667eea; font-weight: 600; margin-bottom: 8px; }
        .schedule-title { font-size: 1rem; font-weight: 600; color: #333; margin-bottom: 5px; }
        .schedule-info { font-size: 0.9rem; color: #666; display: flex; align-items: center; gap: 5px; }
        .schedule-info i { color: #999; }
        .schedule-actions { margin-top: 12px; display: flex; gap: 10px; }

        .btn-small {
            padding: 6px 15px;
            font-size: 0.85rem;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
        }
        .btn-primary { background: #667eea; color: white; }
        .btn-primary:hover { background: #5568d3; }
        .btn-secondary { background: #e0e0e0; color: #666; }
        .btn-secondary:hover { background: #d0d0d0; }

        /* ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒªã‚¹ãƒˆ */
        .message-item {
            padding: 15px;
            border-bottom: 1px solid #f0f0f0;
            cursor: pointer;
            transition: background 0.3s ease;
        }
        .message-item:hover { background: #f8f9fa; }
        .message-item:last-child { border-bottom: none; }
        .message-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .message-sender { font-weight: 600; color: #333; font-size: 0.95rem; }
        .message-time { font-size: 0.8rem; color: #999; }
        .message-preview { font-size: 0.9rem; color: #666; line-height: 1.5; }
        .message-unread { background: #e3f2fd; }
        .unread-badge {
            display: inline-block;
            width: 8px; height: 8px;
            background: #f5576c;
            border-radius: 50%;
            margin-right: 8px;
        }

        /* ä¼æ¥­ãƒªã‚¹ãƒˆ */
        .company-item {
            display: flex; align-items: center; gap: 15px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
            margin-bottom: 12px;
        }
        .company-item:last-child { margin-bottom: 0; }
        .company-status { width: 8px; height: 40px; border-radius: 4px; }
        .status-passed { background: #4caf50; }
        .status-pending { background: #ff9800; }
        .status-new { background: #2196F3; }
        .company-info { flex: 1; }
        .company-name { font-weight: 600; color: #333; margin-bottom: 5px; }
        .company-status-text { font-size: 0.85rem; color: #666; }
        .company-action {
            padding: 6px 15px;
            background: #667eea;
            color: white;
            border-radius: 6px;
            text-decoration: none;
            font-size: 0.85rem;
            transition: all 0.3s ease;
        }
        .company-action:hover { background: #5568d3; }

        /* æ›¸é¡ãƒªã‚¹ãƒˆ */
        .document-item {
            display: flex; align-items: center; gap: 15px;
            padding: 12px 15px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            margin-bottom: 10px;
            transition: all 0.3s ease;
        }
        .document-item:hover { border-color: #667eea; background: #f8f9fa; }
        .document-item:last-child { margin-bottom: 0; }
        .document-icon { font-size: 1.5rem; color: #667eea; }
        .document-info { flex: 1; }
        .document-name { font-weight: 600; color: #333; font-size: 0.95rem; margin-bottom: 3px; }
        .document-meta { font-size: 0.8rem; color: #999; }
        .document-actions { display: flex; gap: 10px; }
        .btn-icon {
            width: 32px; height: 32px;
            border-radius: 6px;
            border: none;
            background: #f0f0f0;
            color: #666;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }
        .btn-icon:hover { background: #667eea; color: white; }

        /* çµ±è¨ˆã‚«ãƒ¼ãƒ‰ */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }
        .stat-item {
            text-align: center;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
        }
        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: #667eea;
            margin-bottom: 5px;
        }
        .stat-label { font-size: 0.9rem; color: #666; }

        /* ç©ºã®çŠ¶æ…‹ */
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #999;
        }
        .empty-state i {
            font-size: 3rem;
            margin-bottom: 15px;
            opacity: 0.3;
        }
        .empty-state p { font-size: 0.95rem; margin-bottom: 15px; }

        /* ãƒœã‚¿ãƒ³ */
        .btn {
            padding: 10px 24px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-size: 0.95rem;
            font-weight: 600;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
        }
        .btn-outline {
            background: white;
            color: #667eea;
            border: 2px solid #667eea;
        }
        .btn-outline:hover { background: #667eea; color: white; }

        .view-all { text-align: center; margin-top: 15px; }
        .view-all a {
            color: #667eea;
            text-decoration: none;
            font-size: 0.9rem;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }
        .view-all a:hover { text-decoration: underline; }

        /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ– */
        @media (max-width: 1024px) {
            .main-container { grid-template-columns: 1fr; }
            .sidebar { position: static; }
            .sidebar-menu {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
                gap: 10px;
            }
        }

        @media (max-width: 768px) {
            .header-container { flex-direction: column; gap: 15px; }
            .welcome-card h1 { font-size: 1.5rem; }
            .card-grid { grid-template-columns: 1fr; }
            .stats-grid { grid-template-columns: 1fr; }
            .user-info span { display: none; }
        }
    </style>
</head>
<body>
    <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
    <header class="header">
        <div class="header-container">
            <div class="header-left">
                <a href="index.html" class="logo">
                    <i class="fas fa-home"></i>
                    <span>å®¶æ—å¸¯åŒæ”¯æ´ãƒ—ãƒ­ã‚°ãƒ©ãƒ </span>
                </a>
            </div>
            <div class="header-right">
                <div class="user-info">
                    <div class="user-avatar">ç”°</div>
                    <span>ç”°ä¸­æ§˜</span>
                </div>
                <a href="log-in.html" class="logout-btn">
                    <i class="fas fa-sign-out-alt"></i>
                    ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
                </a>
            </div>
        </div>
    </header>

    <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒŠ -->
    <div class="main-container">
        <!-- ã‚µã‚¤ãƒ‰ãƒãƒ¼ -->
        <aside class="sidebar">
            <div class="sidebar-title">ãƒ¡ãƒ‹ãƒ¥ãƒ¼</div>
            <ul class="sidebar-menu">
                <li><a href="#" class="active"><i class="fas fa-home"></i> ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</a></li>
                <li><a href="meeting-booking.html"><i class="fas fa-calendar-alt"></i> é¢è«‡äºˆç´„</a></li>
                <li><a href="job-list.html"><i class="fas fa-building"></i> ä¼æ¥­ç´¹ä»‹</a></li>
                <li><a href="job-applications.html"><i class="fas fa-file-alt"></i> å¿œå‹Ÿç®¡ç†</a></li>
                <li><a href="documents-list.html"><i class="fas fa-folder-open"></i> å¿œå‹Ÿæ›¸é¡</a></li>
                <li><a href="messages.html"><i class="fas fa-envelope"></i> ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸</a></li>
                <li><a href="activity-report.html"><i class="fas fa-chart-line"></i> æ´»å‹•ãƒ¬ãƒãƒ¼ãƒˆ</a></li>
                <li><a href="profile-edit.html"><i class="fas fa-user"></i> ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç·¨é›†</a></li>
                <li><a href="#settings"><i class="fas fa-cog"></i> è¨­å®š</a></li>
                <li><a href="manual.html" target="_blank"><i class="fas fa-book"></i> ä½¿ã„æ–¹ãƒãƒ‹ãƒ¥ã‚¢ãƒ«</a></li>
            </ul>
        </aside>

        <!-- ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
        <main class="content">
            <!-- ã‚¦ã‚§ãƒ«ã‚«ãƒ ã‚«ãƒ¼ãƒ‰ -->
            <div class="welcome-card">
                <h1>ã“ã‚“ã«ã¡ã¯ã€ç”°ä¸­æ§˜ ğŸ‘‹</h1>
                <p id="last-login-time">æœ€çµ‚ãƒ­ã‚°ã‚¤ãƒ³: èª­ã¿è¾¼ã¿ä¸­...</p>
            </div>

            <!-- ã‚«ãƒ¼ãƒ‰ã‚°ãƒªãƒƒãƒ‰ -->
            <div class="card-grid">
                <!-- æ¬¡å›ã®äºˆå®š -->
                <div class="card">
                    <div class="card-header">
                        <div class="card-icon schedule">
                            <i class="fas fa-calendar-check"></i>
                        </div>
                        <div class="card-title">æ¬¡å›ã®äºˆå®š</div>
                    </div>

                    <div id="next-meeting-container">
                    <!-- JavaScriptã§å‹•çš„ã«ç”Ÿæˆ -->
                    <div class="empty-state" style="padding: 30px 20px; text-align: center; color: #999;">
                        <i class="fas fa-spinner fa-spin" style="font-size: 2rem; margin-bottom: 15px; opacity: 0.3;"></i>
                        <p style="font-size: 0.95rem;">èª­ã¿è¾¼ã¿ä¸­...</p>
                    </div>
                </div>

                    <div class="view-all">
                        <a href="meeting-booking.html">
                            ã™ã¹ã¦ã®äºˆå®šã‚’è¦‹ã‚‹
                            <i class="fas fa-chevron-right"></i>
                        </a>
                    </div>
                </div>

                <!-- ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ -->
                <div class="card">
                    <div class="card-header">
                        <div class="card-icon message">
                            <i class="fas fa-envelope"></i>
                        </div>
                        <div class="card-title">ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸</div>
                        <span class="card-count">2ä»¶æœªèª­</span>
                    </div>

                    <div id="messages-container">
                    <!-- JavaScriptã§å‹•çš„ã«ç”Ÿæˆ -->
                    <div class="empty-state" style="padding: 30px 20px; text-align: center; color: #999;">
                        <i class="fas fa-spinner fa-spin" style="font-size: 2rem; margin-bottom: 15px; opacity: 0.3;"></i>
                        <p style="font-size: 0.95rem;">èª­ã¿è¾¼ã¿ä¸­...</p>
                    </div>
                </div>
                        <div class="message-preview">
                            æ–°ã—ã„ä¼æ¥­ç´¹ä»‹ãŒã‚ã‚Šã¾ã™ã€‚ãƒã‚¤ãƒšãƒ¼ã‚¸ã§ã”ç¢ºèªãã ã•ã„ã€‚
                        </div>
                    </div>

                    <div class="view-all">
                        <a href="#messages">
                            ã™ã¹ã¦ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¦‹ã‚‹
                            <i class="fas fa-chevron-right"></i>
                        </a>
                    </div>
                </div>
            </div>

            <!-- ç¬¬2è¡Œ -->
            <div class="card-grid">
                <!-- ç´¹ä»‹ä¼æ¥­ãƒªã‚¹ãƒˆ -->
                <div class="card">
                    <div class="card-header">
                        <div class="card-icon company">
                            <i class="fas fa-building"></i>
                        </div>
                        <div class="card-title">ç´¹ä»‹ä¼æ¥­ãƒªã‚¹ãƒˆ</div>
                        <span class="card-count">3ç¤¾</span>
                    </div>

                    <div id="companies-container">
                    <!-- JavaScriptã§å‹•çš„ã«ç”Ÿæˆ -->
                    <div class="empty-state" style="padding: 30px 20px; text-align: center; color: #999;">
                        <i class="fas fa-spinner fa-spin" style="font-size: 2rem; margin-bottom: 15px; opacity: 0.3;"></i>
                        <p style="font-size: 0.95rem;">èª­ã¿è¾¼ã¿ä¸­...</p>
                    </div>
                </div>
                        <div class="company-info">
                            <div class="company-name">DEFæ ªå¼ä¼šç¤¾</div>
                            <div class="company-status-text">ç´¹ä»‹æ¸ˆã¿ï¼ˆæœªå¿œå‹Ÿï¼‰</div>
                        </div>
                        <a href="#" class="company-action">å¿œå‹Ÿ</a>
                    </div>

                    <div class="view-all">
                        <a href="#companies">
                            ã™ã¹ã¦ã®ä¼æ¥­ã‚’è¦‹ã‚‹
                            <i class="fas fa-chevron-right"></i>
                        </a>
                    </div>
                </div>

                <!-- å¿œå‹Ÿæ›¸é¡ -->
                <div class="card">
                    <div class="card-header">
                        <div class="card-icon document">
                            <i class="fas fa-file-alt"></i>
                        </div>
                        <div class="card-title">å¿œå‹Ÿæ›¸é¡</div>
                        <span class="card-count">3ä»¶</span>
                    </div>

                    <div class="document-item">
                        <i class="fas fa-file-pdf document-icon"></i>
                        <div class="document-info">
                            <div class="document-name">å±¥æ­´æ›¸_v3.pdf</div>
                            <div class="document-meta">æœ€çµ‚æ›´æ–°: 2026/1/8 | 245KB</div>
                        </div>
                        <div class="document-actions">
                            <button class="btn-icon" title="ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰">
                                <i class="fas fa-download"></i>
                            </button>
                            <button class="btn-icon" title="å‰Šé™¤">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>

                    <div class="document-item">
                        <i class="fas fa-file-pdf document-icon"></i>
                        <div class="document-info">
                            <div class="document-name">è·å‹™çµŒæ­´æ›¸_v2.pdf</div>
                            <div class="document-meta">æœ€çµ‚æ›´æ–°: 2026/1/5 | 312KB</div>
                        </div>
                        <div class="document-actions">
                            <button class="btn-icon" title="ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰">
                                <i class="fas fa-download"></i>
                            </button>
                            <button class="btn-icon" title="å‰Šé™¤">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>

                    <div class="document-item">
                        <i class="fas fa-file-pdf document-icon"></i>
                        <div class="document-info">
                            <div class="document-name">ã‚«ãƒãƒ¼ãƒ¬ã‚¿ãƒ¼_ABCç¤¾.pdf</div>
                            <div class="document-meta">æœ€çµ‚æ›´æ–°: 2026/1/8 | 128KB</div>
                        </div>
                        <div class="document-actions">
                            <button class="btn-icon" title="ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰">
                                <i class="fas fa-download"></i>
                            </button>
                            <button class="btn-icon" title="å‰Šé™¤">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>

                    <div class="view-all">
                        <a href="documents-upload.html">
                            <i class="fas fa-plus-circle"></i>
                            æ–°ã—ã„æ›¸é¡ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
                        </a>
                    </div>
                </div>
            </div>

            <!-- æ´»å‹•ã‚µãƒãƒªãƒ¼ -->
            <div class="card">
                <div class="card-header">
                    <div class="card-icon stats">
                        <i class="fas fa-chart-pie"></i>
                    </div>
                    <div class="card-title">æ´»å‹•ã‚µãƒãƒªãƒ¼</div>
                </div>

                <div class="stats-grid" id="stats-grid">
                    <div class="stat-item">
                        <div class="stat-value">5</div>
                        <div class="stat-label">é¢è«‡å®Ÿæ–½å›æ•°</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value">3</div>
                        <div class="stat-label">å¿œå‹Ÿä¼æ¥­æ•°</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value">67%</div>
                        <div class="stat-label">æ›¸é¡é€šéç‡</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value">21</div>
                        <div class="stat-label">åˆ©ç”¨æ—¥æ•°</div>
                    </div>
                </div>

                <div class="view-all">
                    <a href="#reports">
                        è©³ç´°ãƒ¬ãƒãƒ¼ãƒˆã‚’è¦‹ã‚‹
                        <i class="fas fa-chevron-right"></i>
                    </a>
                </div>
            </div>
        </main>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import {
            getFirestore, doc, getDoc, setDoc, serverTimestamp,
            collection, query, where, orderBy, limit as firestoreLimit, getDocs, deleteDoc
        } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        import { getStorage, ref as storageRef, deleteObject } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js';

        // Firebaseè¨­å®š
        const firebaseConfig = {
            apiKey: "AIzaSyA6iFUhXOueccuoLJVU9ZSvXywHmj8zoR4",
            authDomain: "university-relocation-support.firebaseapp.com",
            projectId: "university-relocation-support",
            storageBucket: "university-relocation-support.firebasestorage.app",
            messagingSenderId: "849634495988",
            appId: "1:849634495988:web:013663976b0c4d6b4f7da1",
            measurementId: "G-RJP20TC7DV"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);

        
        // ================================
        // ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰å‹•çš„ãƒ‡ãƒ¼ã‚¿ãƒ­ãƒ¼ãƒ‰
        // ================================
        
        // æ—¥æ™‚ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆé–¢æ•°
        function formatDateTime(date) {
            if (!date) return 'ä¸æ˜';
            try {
                const d = date instanceof Date ? date : date.toDate();
                const year = d.getFullYear();
                const month = d.getMonth() + 1;
                const day = d.getDate();
                const hours = String(d.getHours()).padStart(2, '0');
                const minutes = String(d.getMinutes()).padStart(2, '0');
                return `${year}å¹´${month}æœˆ${day}æ—¥ ${hours}:${minutes}`;
            } catch (e) {
                return 'ä¸æ˜';
            }
        }
        
        function formatMeetingDateTime(timestamp) {
            if (!timestamp) return 'æ—¥æ™‚æœªå®š';
            try {
                const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
                const year = date.getFullYear();
                const month = date.getMonth() + 1;
                const day = date.getDate();
                const hours = String(date.getHours()).padStart(2, '0');
                const minutes = String(date.getMinutes()).padStart(2, '0');
                
                const weekdays = ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'];
                const weekday = weekdays[date.getDay()];
                
                return `${year}å¹´${month}æœˆ${day}æ—¥ï¼ˆ${weekday}ï¼‰${hours}:${minutes}`;
            } catch (e) {
                return 'æ—¥æ™‚ã‚¨ãƒ©ãƒ¼';
            }
        }
        
        function formatRelativeTime(timestamp) {
            if (!timestamp) return 'ä¸æ˜';
            try {
                const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
                const now = new Date();
                const diff = now - date;
                const minutes = Math.floor(diff / 60000);
                const hours = Math.floor(diff / 3600000);
                const days = Math.floor(diff / 86400000);
                
                if (minutes < 1) return 'ãŸã£ãŸä»Š';
                if (minutes < 60) return `${minutes}åˆ†å‰`;
                if (hours < 24) return `${hours}æ™‚é–“å‰`;
                if (days === 0) return 'ä»Šæ—¥';
                if (days === 1) return 'æ˜¨æ—¥';
                if (days < 7) return `${days}æ—¥å‰`;
                
                const month = date.getMonth() + 1;
                const day = date.getDate();
                return `${month}/${day}`;
            } catch (e) {
                return 'ä¸æ˜';
            }
        }
        
        // æ¬¡å›ã®äºˆå®šã‚’ãƒ­ãƒ¼ãƒ‰ï¼ˆv4: å®Ÿéš›ã®Firestoreãƒ‡ãƒ¼ã‚¿æ§‹é€ ã«å®Œå…¨å¯¾å¿œï¼‰
        async function loadNextMeeting(userId) {
            try {
                console.log('[Dashboard v5] æ¬¡å›ã®äºˆå®šã‚’èª­ã¿è¾¼ã¿ä¸­... userId:', userId);
                console.log('[Dashboard v5] ç¾åœ¨ã®èªè¨¼ãƒ¦ãƒ¼ã‚¶ãƒ¼:', auth.currentUser?.uid);
                
                // ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã®ä¸ä¸€è‡´ã‚’æ¤œå‡º
                if (auth.currentUser && auth.currentUser.uid !== userId) {
                    console.error('[Dashboard v5] âš ï¸ è‡´å‘½çš„ã‚¨ãƒ©ãƒ¼: å¼•æ•°ã®userIdã¨èªè¨¼ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒä¸ä¸€è‡´ï¼', {
                        argument: userId,
                        authenticated: auth.currentUser.uid
                    });
                    throw new Error('User ID mismatch');
                }
                const now = new Date();
                
                // ã‚·ãƒ³ãƒ—ãƒ«ãªã‚¯ã‚¨ãƒªï¼šuserIdã®ã¿ã§æ¤œç´¢ï¼ˆorderByãªã—ï¼‰
                const q = query(
                    collection(db, 'meetings'),
                    where('userId', '==', userId)
                );
                
                const snapshot = await getDocs(q);
                console.log('[Dashboard v5] å–å¾—ã—ãŸäºˆå®šæ•°:', snapshot.size);
                
                const container = document.getElementById('next-meeting-container');
                if (!container) return;
                
                if (snapshot.empty) {
                    console.log('[Dashboard v5] äºˆå®šãƒ‡ãƒ¼ã‚¿ãªã—');
                    container.innerHTML = `
                        <div class="empty-state" style="padding: 30px 20px; text-align: center; color: #999;">
                            <i class="fas fa-calendar-xmark" style="font-size: 2.5rem; margin-bottom: 15px; opacity: 0.3;"></i>
                            <p style="font-size: 0.95rem; margin-bottom: 15px;">äºˆå®šãŒã‚ã‚Šã¾ã›ã‚“</p>
                            <a href="meeting-booking.html" class="btn btn-outline" style="font-size:0.9rem; padding:8px 20px;">
                                <i class="fas fa-calendar-plus"></i> é¢è«‡ã‚’äºˆç´„ã™ã‚‹
                            </a>
                        </div>
                    `;
                    return;
                }
                
                // æœªæ¥ã®äºˆå®šã‚’åé›†ã—ã¦ã‚½ãƒ¼ãƒˆ
                const upcomingMeetings = [];
                
                for (const doc of snapshot.docs) {
                    const data = doc.data();
                    console.log('[Dashboard v5] äºˆå®šãƒã‚§ãƒƒã‚¯:', {
                        id: doc.id,
                        type: data.type,
                        datetime: data.datetime,
                        date: data.date,
                        status: data.status
                    });
                    
                    // ã‚­ãƒ£ãƒ³ã‚»ãƒ«æ¸ˆã¿ã‚’ã‚¹ã‚­ãƒƒãƒ—
                    if (data.status === 'cancelled') {
                        console.log('[Dashboard v5] ã‚­ãƒ£ãƒ³ã‚»ãƒ«æ¸ˆã¿ã€ã‚¹ã‚­ãƒƒãƒ—');
                        continue;
                    }
                    
                    // æ—¥æ™‚ã‚’ãƒ‘ãƒ¼ã‚¹ï¼ˆè¤‡æ•°ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰å½¢å¼ã«å¯¾å¿œï¼‰
                    let meetingDate = null;
                    
                    // ãƒ‘ã‚¿ãƒ¼ãƒ³1: datetime ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ï¼ˆæ–‡å­—åˆ—ï¼‰
                    if (data.datetime) {
                        try {
                            // "2026å¹´1æœˆ20æ—¥ 14:00:00 UTC+9" å½¢å¼ã‚’ãƒ‘ãƒ¼ã‚¹
                            const dateStr = data.datetime.replace(/å¹´|æœˆ/g, '-').replace(/æ—¥/g, '');
                            meetingDate = new Date(dateStr);
                            console.log('[Dashboard v5] datetime ã‹ã‚‰ãƒ‘ãƒ¼ã‚¹:', meetingDate);
                        } catch (e) {
                            console.warn('[Dashboard v5] datetime ãƒ‘ãƒ¼ã‚¹ã‚¨ãƒ©ãƒ¼:', e);
                        }
                    }
                    
                    // ãƒ‘ã‚¿ãƒ¼ãƒ³2: date + startTime ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰
                    if (!meetingDate && data.date && data.startTime) {
                        try {
                            const dateTimeStr = `${data.date}T${data.startTime}:00`;
                            meetingDate = new Date(dateTimeStr);
                            console.log('[Dashboard v5] date + startTime ã‹ã‚‰ãƒ‘ãƒ¼ã‚¹:', meetingDate);
                        } catch (e) {
                            console.warn('[Dashboard v5] date + startTime ãƒ‘ãƒ¼ã‚¹ã‚¨ãƒ©ãƒ¼:', e);
                        }
                    }
                    
                    // ãƒ‘ã‚¿ãƒ¼ãƒ³3: requestedAt ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ï¼ˆTimestampï¼‰
                    if (!meetingDate && data.requestedAt) {
                        try {
                            meetingDate = data.requestedAt.toDate();
                            console.log('[Dashboard v5] requestedAt ã‹ã‚‰ãƒ‘ãƒ¼ã‚¹:', meetingDate);
                        } catch (e) {
                            console.warn('[Dashboard v5] requestedAt ãƒ‘ãƒ¼ã‚¹ã‚¨ãƒ©ãƒ¼:', e);
                        }
                    }
                    
                    if (!meetingDate || isNaN(meetingDate.getTime())) {
                        console.warn('[Dashboard v5] æœ‰åŠ¹ãªæ—¥æ™‚ãŒå–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ');
                        continue;
                    }
                    
                    // æœªæ¥ã®äºˆå®šã®ã¿
                    if (meetingDate >= now) {
                        console.log('[Dashboard v5] æœªæ¥ã®äºˆå®šã‚’ç™ºè¦‹:', meetingDate);
                        upcomingMeetings.push({
                            date: meetingDate,
                            data: data
                        });
                    } else {
                        console.log('[Dashboard v5] éå»ã®äºˆå®šã€ã‚¹ã‚­ãƒƒãƒ—:', meetingDate);
                    }
                }
                
                if (upcomingMeetings.length === 0) {
                    console.log('[Dashboard v5] æœªæ¥ã®äºˆå®šãªã—');
                    container.innerHTML = `
                        <div class="empty-state" style="padding: 30px 20px; text-align: center; color: #999;">
                            <i class="fas fa-calendar-xmark" style="font-size: 2.5rem; margin-bottom: 15px; opacity: 0.3;"></i>
                            <p style="font-size: 0.95rem; margin-bottom: 15px;">äºˆå®šãŒã‚ã‚Šã¾ã›ã‚“</p>
                            <a href="meeting-booking.html" class="btn btn-outline" style="font-size:0.9rem; padding:8px 20px;">
                                <i class="fas fa-calendar-plus"></i> é¢è«‡ã‚’äºˆç´„ã™ã‚‹
                            </a>
                        </div>
                    `;
                    return;
                }
                
                // æ—¥ä»˜é †ã«ã‚½ãƒ¼ãƒˆ
                upcomingMeetings.sort((a, b) => a.date - b.date);
                const nextMeeting = upcomingMeetings[0];
                
                console.log('[Dashboard v5] æ¬¡å›ã®äºˆå®šã‚’è¡¨ç¤º:', nextMeeting.data.type || nextMeeting.data.requestType);
                
                // æ—¥æ™‚ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
                const dateOptions = { 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric', 
                    weekday: 'short',
                    hour: '2-digit',
                    minute: '2-digit'
                };
                const formattedDate = nextMeeting.date.toLocaleDateString('ja-JP', dateOptions);
                
                container.innerHTML = `
                    <div class="schedule-item">
                        <div class="schedule-date">${formattedDate}</div>
                        <div class="schedule-title">${escapeHtml(nextMeeting.data.type || nextMeeting.data.requestType || 'é¢è«‡')}</div>
                        <div class="schedule-info">
                            <i class="fas fa-video"></i>
                            <span>${escapeHtml(nextMeeting.data.location || nextMeeting.data.meetingType || 'ã‚ªãƒ³ãƒ©ã‚¤ãƒ³')}</span>
                        </div>
                        <div class="schedule-actions">
                            <a href="my-meetings.html" class="btn-small btn-primary">è©³ç´°ã‚’è¦‹ã‚‹</a>
                        </div>
                    </div>
                `;
            } catch (error) {
                console.error('[Dashboard v5] äºˆå®šèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                console.error('[Dashboard v5] ã‚¨ãƒ©ãƒ¼è©³ç´°:', error.code, error.message);
                const container = document.getElementById('next-meeting-container');
                if (container) {
                    let errorMsg = 'èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼';
                    if (error.code === 'permission-denied') {
                        errorMsg = 'ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“';
                    } else if (error.code === 'failed-precondition') {
                        errorMsg = 'ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ãŒå¿…è¦ã§ã™ã€‚Consoleã®ãƒªãƒ³ã‚¯ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„';
                    } else if (error.message) {
                        errorMsg = error.message.substring(0, 100);
                    }
                    container.innerHTML = `
                        <div class="empty-state" style="padding: 30px 20px; text-align: center; color: #999;">
                            <i class="fas fa-exclamation-triangle" style="font-size: 2.5rem; margin-bottom: 15px; color: #ff9800;"></i>
                            <p style="font-size: 0.95rem; margin-bottom: 10px;">èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼</p>
                            <p style="font-size: 0.85rem; color: #666;">${errorMsg}</p>
                            <p style="font-size: 0.8rem; color: #999; margin-top: 10px;">
                                é–‹ç™ºè€…ãƒ„ãƒ¼ãƒ«ã®ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã§è©³ç´°ã‚’ç¢ºèªã—ã¦ãã ã•ã„
                            </p>
                        </div>
                    `;
                }
            }
        }
        
        // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ãƒ­ãƒ¼ãƒ‰
        async function loadMessages(userId) {
            try {
                const q = query(
                    collection(db, 'messages'),
                    where('recipientId', '==', userId),
                    where('read', '==', false),
                    orderBy('createdAt', 'desc'),
                    firestoreLimit(2)
                );
                
                const snapshot = await getDocs(q);
                const container = document.getElementById('messages-container');
                const countBadge = document.querySelector('.card-icon.message')?.closest('.card')?.querySelector('.card-count');
                
                if (!container) return;
                
                if (snapshot.empty) {
                    container.innerHTML = `
                        <div class="empty-state" style="padding: 30px 20px; text-align: center; color: #999;">
                            <i class="fas fa-envelope-open" style="font-size: 2.5rem; margin-bottom: 15px; opacity: 0.3;"></i>
                            <p style="font-size: 0.95rem;">æ–°ç€ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯ã‚ã‚Šã¾ã›ã‚“</p>
                        </div>
                    `;
                    if (countBadge) countBadge.textContent = '0ä»¶';
                    return;
                }
                
                container.innerHTML = '';
                snapshot.forEach((doc) => {
                    const msg = doc.data();
                    const messageDiv = document.createElement('div');
                    messageDiv.className = 'message-item message-unread';
                    messageDiv.innerHTML = `
                        <div class="message-header">
                            <div class="message-sender">
                                <span class="unread-badge"></span>
                                ${escapeHtml(msg.senderName || 'é€ä¿¡è€…')}
                            </div>
                            <div class="message-time">${formatRelativeTime(msg.createdAt)}</div>
                        </div>
                        <div class="message-preview">
                            ${escapeHtml((msg.content || '').substring(0, 50))}${msg.content && msg.content.length > 50 ? '...' : ''}
                        </div>
                    `;
                    container.appendChild(messageDiv);
                });
                
                if (countBadge) countBadge.textContent = `${snapshot.size}ä»¶æœªèª­`;
            } catch (error) {
                console.error('ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                console.error('ã‚¨ãƒ©ãƒ¼è©³ç´°:', error.code, error.message);
                const container = document.getElementById('messages-container');
                if (container) {
                    let errorMsg = 'èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼';
                    if (error.code === 'permission-denied') {
                        errorMsg = 'ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“';
                    } else if (error.code === 'failed-precondition') {
                        errorMsg = 'ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ãŒå¿…è¦ã§ã™';
                    } else if (error.message) {
                        errorMsg = error.message.substring(0, 100);
                    }
                    container.innerHTML = `
                        <div class="empty-state" style="padding: 30px 20px; text-align: center; color: #999;">
                            <i class="fas fa-exclamation-triangle" style="font-size: 2.5rem; margin-bottom: 15px; color: #ff9800;"></i>
                            <p style="font-size: 0.95rem; margin-bottom: 10px;">èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼</p>
                            <p style="font-size: 0.85rem; color: #666;">${errorMsg}</p>
                            <p style="font-size: 0.8rem; color: #999; margin-top: 10px;">
                                é–‹ç™ºè€…ãƒ„ãƒ¼ãƒ«ã®ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã§è©³ç´°ã‚’ç¢ºèªã—ã¦ãã ã•ã„
                            </p>
                        </div>
                    `;
                }
            }
        }
        
        // ä¼æ¥­ãƒªã‚¹ãƒˆã‚’ãƒ­ãƒ¼ãƒ‰
        async function loadCompanies(userId) {
            try {
                const q = query(
                    collection(db, 'applications'),
                    where('userId', '==', userId),
                    orderBy('appliedAt', 'desc'),
                    firestoreLimit(3)
                );
                
                const snapshot = await getDocs(q);
                const container = document.getElementById('companies-container');
                const countBadge = document.querySelector('.card-icon.company')?.closest('.card')?.querySelector('.card-count');
                
                if (!container) return;
                
                if (snapshot.empty) {
                    container.innerHTML = `
                        <div class="empty-state" style="padding: 30px 20px; text-align: center; color: #999;">
                            <i class="fas fa-building" style="font-size: 2.5rem; margin-bottom: 15px; opacity: 0.3;"></i>
                            <p style="font-size: 0.95rem;">ç´¹ä»‹ä¼æ¥­ã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“</p>
                        </div>
                    `;
                    if (countBadge) countBadge.textContent = '0ç¤¾';
                    return;
                }
                
                container.innerHTML = '';
                snapshot.forEach((doc) => {
                    const app = doc.data();
                    const companyDiv = document.createElement('div');
                    companyDiv.className = 'company-item';
                    
                    const statusClass = getCompanyStatusClass(app.status);
                    const statusText = getCompanyStatusText(app.status, app.appliedAt);
                    
                    companyDiv.innerHTML = `
                        <div class="company-status ${statusClass}"></div>
                        <div class="company-info">
                            <div class="company-name">${escapeHtml(app.companyName || 'ä¼æ¥­å')}</div>
                            <div class="company-status-text">${statusText}</div>
                        </div>
                        <a href="job-applications.html" class="company-action">è©³ç´°</a>
                    `;
                    container.appendChild(companyDiv);
                });
                
                if (countBadge) countBadge.textContent = `${snapshot.size}ç¤¾`;
            } catch (error) {
                console.error('ä¼æ¥­ãƒªã‚¹ãƒˆèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                const container = document.getElementById('companies-container');
                if (container) {
                    container.innerHTML = `
                        <div class="empty-state" style="padding: 30px 20px; text-align: center; color: #999;">
                            <i class="fas fa-exclamation-triangle" style="font-size: 2.5rem; margin-bottom: 15px; opacity: 0.3;"></i>
                            <p style="font-size: 0.95rem;">èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼</p>
                        </div>
                    `;
                }
            }
        }
        
        function getCompanyStatusClass(status) {
            const map = {
                'passed': 'status-passed',
                'interview': 'status-passed',
                'pending': 'status-pending',
                'applied': 'status-pending',
                'new': 'status-new'
            };
            return map[status] || 'status-new';
        }
        
        function getCompanyStatusText(status, appliedAt) {
            const map = {
                'passed': 'æ›¸é¡é¸è€ƒé€šé',
                'interview': 'é¢æ¥äºˆå®š',
                'pending': 'å¿œå‹Ÿä¸­',
                'applied': 'å¿œå‹Ÿä¸­',
                'new': 'ç´¹ä»‹æ¸ˆã¿'
            };
            let text = map[status] || 'å¿œå‹Ÿå‰';
            
            if (appliedAt) {
                try {
                    const date = appliedAt.toDate ? appliedAt.toDate() : new Date(appliedAt);
                    const month = date.getMonth() + 1;
                    const day = date.getDate();
                    text += ` ï¼ˆ${month}/${day}å¿œå‹Ÿï¼‰`;
                } catch (e) {
                    // ignore
                }
            }
            
            return text;
        }
        
        // æ´»å‹•çµ±è¨ˆã‚’ãƒ­ãƒ¼ãƒ‰
        async function loadActivityStats(userId) {
            try {
                // é¢è«‡å®Ÿæ–½å›æ•°
                const meetingsQuery = query(
                    collection(db, 'meetings'),
                    where('userId', '==', userId),
                    where('status', '==', 'completed')
                );
                const meetingsSnapshot = await getDocs(meetingsQuery);
                const meetingsCount = meetingsSnapshot.size;
                
                // å¿œå‹Ÿä¼æ¥­æ•°
                const applicationsQuery = query(
                    collection(db, 'applications'),
                    where('userId', '==', userId)
                );
                const applicationsSnapshot = await getDocs(applicationsQuery);
                const applicationsCount = applicationsSnapshot.size;
                
                // æ›¸é¡é€šéç‡
                let passedCount = 0;
                applicationsSnapshot.forEach((doc) => {
                    const data = doc.data();
                    if (data.status === 'passed' || data.status === 'interview') {
                        passedCount++;
                    }
                });
                const passRate = applicationsCount > 0 
                    ? Math.round((passedCount / applicationsCount) * 100) 
                    : 0;
                
                // åˆ©ç”¨æ—¥æ•°
                const userDoc = await getDoc(doc(db, 'users', userId));
                const userData = userDoc.data();
                const createdAt = userData?.createdAt?.toDate ? userData.createdAt.toDate() : null;
                const daysUsed = createdAt 
                    ? Math.max(1, Math.floor((new Date() - createdAt) / (1000 * 60 * 60 * 24)))
                    : 1;
                
                // è¡¨ç¤º
                const statsGrid = document.getElementById('stats-grid');
                if (statsGrid) {
                    statsGrid.innerHTML = `
                        <div class="stat-item">
                            <div class="stat-value">${meetingsCount}</div>
                            <div class="stat-label">é¢è«‡å®Ÿæ–½å›æ•°</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value">${applicationsCount}</div>
                            <div class="stat-label">å¿œå‹Ÿä¼æ¥­æ•°</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value">${passRate}%</div>
                            <div class="stat-label">æ›¸é¡é€šéç‡</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value">${daysUsed}</div>
                            <div class="stat-label">åˆ©ç”¨æ—¥æ•°</div>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('çµ±è¨ˆèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
            }
        }


        // ================================
        // role/ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆå…±é€š
        // ================================
        async function ensureUserDoc(user) {
            if (!user) return null;

            const uid = user.uid;
            const email = user.email || '';
            const userRef = doc(db, 'users', uid);

            const snap = await getDoc(userRef);
            if (snap.exists()) {
                // roleæ¬ è½ã‚’è£œæ­£ï¼ˆç ´å£Šçš„å¤‰æ›´ã¯é¿ã‘ã€èª­ã¿å‡ºã—å´ã§ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆé©ç”¨ï¼‰
                return snap.data();
            }

            const newDoc = {
                uid,
                email,
                role: 'user',
                createdAt: serverTimestamp()
            };

            await setDoc(userRef, newDoc, { merge: true });
            return newDoc;
        }

        async function getUserRoleOrDefault(user) {
            try {
                const data = await ensureUserDoc(user);
                return (data && data.role) ? data.role : 'user';
            } catch (e) {
                console.error('roleå–å¾—/ãƒ¦ãƒ¼ã‚¶ãƒ¼è‡ªå‹•ä½œæˆã‚¨ãƒ©ãƒ¼:', e);
                return 'user';
            }
        }

        // dashboardå´ã‚¬ãƒ¼ãƒ‰
        async function handleDashboardAccessOrRedirect(user) {
            if (!user) {
                window.location.href = 'log-in.html';
                return false;
            }

            const role = await getUserRoleOrDefault(user);

            // ç®¡ç†è€…ã¯ç®¡ç†ç”»é¢ã¸
            if (role === 'admin' || role === 'superadmin') {
                window.location.href = 'admin-dashboard.html';
                return false;
            }

            // ãã‚Œä»¥å¤–ï¼ˆuser/æ¬ è½ï¼‰ã¯è¡¨ç¤ºç¶™ç¶š
            return true;
        }

        // èªè¨¼çŠ¶æ…‹ç›£è¦–ï¼ˆv5: é‡è¤‡å®Ÿè¡Œé˜²æ­¢ï¼‰
        let isAuthProcessing = false;
        let currentUserId = null;
        
        onAuthStateChanged(auth, async (user) => {
            console.log('[Dashboard v5] onAuthStateChanged ç™ºç«:', {
                user: user ? user.uid : 'null',
                email: user ? user.email : 'null',
                isAuthProcessing: isAuthProcessing,
                currentUserId: currentUserId
            });
            
            // é‡è¤‡å®Ÿè¡Œã‚’é˜²æ­¢
            if (isAuthProcessing) {
                console.warn('[Dashboard v5] èªè¨¼å‡¦ç†ä¸­ã®ãŸã‚ã€ã“ã®å‘¼ã³å‡ºã—ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™');
                return;
            }
            
            // ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã®å¤‰åŒ–ã‚’æ¤œå‡º
            if (currentUserId && user && currentUserId !== user.uid) {
                console.warn('[Dashboard v5] âš ï¸ ãƒ¦ãƒ¼ã‚¶ãƒ¼IDãŒå¤‰åŒ–ã—ã¾ã—ãŸï¼', {
                    old: currentUserId,
                    new: user.uid
                });
            }
            
            isAuthProcessing = true;
            
            try {
                const ok = await handleDashboardAccessOrRedirect(user);
                if (!ok) {
                    isAuthProcessing = false;
                    return;
                }

                currentUserId = user.uid;
                console.log('[Dashboard v5] èªè¨¼æ¸ˆã¿ãƒ¦ãƒ¼ã‚¶ãƒ¼:', {
                    uid: user.uid,
                    email: user.email
                });

                // ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’åæ˜ ï¼ˆusers/{uid} ç„¡ã‘ã‚Œã° ensureUserDoc ã§ä½œæˆæ¸ˆã¿ï¼‰
                const userData = await ensureUserDoc(user);
                console.log('[Dashboard v5] Firestoreã‹ã‚‰ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±å–å¾—:', {
                    name: userData?.name,
                    email: userData?.email,
                    role: userData?.role
                });

                const userName = (userData && userData.name) ? userData.name : (user.email ? user.email.split('@')[0] : 'ãƒ¦ãƒ¼ã‚¶ãƒ¼');
                console.log('[Dashboard v5] è¡¨ç¤ºå:', userName);

                const welcomeTitle = document.querySelector('.welcome-card h1');
                if (welcomeTitle) welcomeTitle.textContent = `ã“ã‚“ã«ã¡ã¯ã€${userName}æ§˜ ğŸ‘‹`;

                const userAvatar = document.querySelector('.user-avatar');
                if (userAvatar && userName) userAvatar.textContent = userName.charAt(0);

                const userInfoSpan = document.querySelector('.user-info span');
                if (userInfoSpan) userInfoSpan.textContent = userName;

                await loadRecentDocuments(user.uid);
                
                // æœ€çµ‚ãƒ­ã‚°ã‚¤ãƒ³æ™‚åˆ»ã‚’æ›´æ–°
                const lastLoginP = document.getElementById('last-login-time');
                if (lastLoginP) {
                    const now = new Date();
                    const formatted = formatDateTime(now);
                    lastLoginP.textContent = `æœ€çµ‚ãƒ­ã‚°ã‚¤ãƒ³: ${formatted}`;
                    
                    await setDoc(doc(db, 'users', user.uid), {
                        lastLoginAt: serverTimestamp()
                    }, { merge: true });
                }

                // å„ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’ãƒ­ãƒ¼ãƒ‰
                console.log('[Dashboard v5] ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿é–‹å§‹:', user.uid);
                await loadNextMeeting(user.uid);
                await loadMessages(user.uid);
                await loadCompanies(user.uid);
                await loadActivityStats(user.uid);
                console.log('[Dashboard v5] ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿å®Œäº†');
            } catch (error) {
                console.error('[Dashboard v5] ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
            } finally {
                isAuthProcessing = false;
            }
        });

        // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆå‡¦ç†
        document.addEventListener('DOMContentLoaded', () => {
            const logoutBtn = document.querySelector('.logout-btn');
            if (!logoutBtn) return;

            logoutBtn.addEventListener('click', async (e) => {
                e.preventDefault();

                const confirmed = confirm('ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã™ã‹ï¼Ÿ');
                if (!confirmed) return;

                try {
                    await signOut(auth);
                    window.location.href = 'log-in.html';
                } catch (error) {
                    console.error('ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã‚¨ãƒ©ãƒ¼:', error);
                    alert('ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚');
                }
            });
        });

        // ============================================
        // æ›¸é¡ç®¡ç†ï¼ˆæœ€æ–°3ä»¶è¡¨ç¤ºï¼‰
        // ============================================
        async function loadRecentDocuments(userId) {
            try {
                const q = query(
                    collection(db, 'documents'),
                    where('userId', '==', userId),
                    orderBy('uploadedAt', 'desc'),
                    firestoreLimit(3)
                );

                const querySnapshot = await getDocs(q);
                const documents = [];
                querySnapshot.forEach((docSnap) => {
                    documents.push({ id: docSnap.id, ...docSnap.data() });
                });

                displayDocuments(documents);
                updateDocumentCount(documents.length);

            } catch (error) {
                console.error('æ›¸é¡èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                displayEmptyState('èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼');
            }
        }

        function displayDocuments(documents) {
            const card = document.querySelector('.card-icon.document')?.closest('.card');
            if (!card) return;

            // æ—¢å­˜ document-item / empty-state ã‚’é™¤å»
            card.querySelectorAll('.document-item').forEach(el => el.remove());
            card.querySelector('.empty-state')?.remove();

            const viewAllDiv = card.querySelector('.view-all');

            if (!documents || documents.length === 0) {
                const emptyDiv = document.createElement('div');
                emptyDiv.className = 'empty-state';
                emptyDiv.style.padding = '30px 20px';
                emptyDiv.innerHTML = `
                    <i class="fas fa-file-alt"></i>
                    <p>ã¾ã æ›¸é¡ãŒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã•ã‚Œã¦ã„ã¾ã›ã‚“</p>
                    <a href="documents-upload.html" class="btn btn-outline" style="font-size:0.9rem; padding:8px 20px;">
                        <i class="fas fa-upload"></i> æœ€åˆã®æ›¸é¡ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
                    </a>
                `;
                card.insertBefore(emptyDiv, viewAllDiv);
                return;
            }

            documents.forEach(docItem => {
                const item = createDocumentItem(docItem);
                card.insertBefore(item, viewAllDiv);
            });
        }

        function createDocumentItem(docItem) {
            const div = document.createElement('div');
            div.className = 'document-item';

            const fileIcon = getFileIcon(docItem.fileType || docItem.fileName);
            const fileSize = formatFileSize(docItem.fileSize);
            const uploadDate = formatDate(docItem.uploadedAt);

            const safeFileName = escapeHtml(docItem.fileName || '');
            const safeDownloadURL = escapeHtml(docItem.downloadURL || '');

            div.innerHTML = `
                <i class="${fileIcon} document-icon"></i>
                <div class="document-info">
                    <div class="document-name">${safeFileName}</div>
                    <div class="document-meta">æœ€çµ‚æ›´æ–°: ${uploadDate} | ${fileSize}</div>
                </div>
                <div class="document-actions">
                    <button class="btn-icon" title="ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰" data-action="download" data-url="${safeDownloadURL}">
                        <i class="fas fa-download"></i>
                    </button>
                    <button class="btn-icon" title="å‰Šé™¤" data-action="delete" data-id="${escapeHtml(docItem.id)}" data-name="${safeFileName}">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            `;

            div.querySelector('[data-action="download"]')?.addEventListener('click', function() {
                downloadDocument(this.getAttribute('data-url'));
            });

            div.querySelector('[data-action="delete"]')?.addEventListener('click', function() {
                const id = this.getAttribute('data-id');
                const name = this.getAttribute('data-name');
                confirmDeleteDocument(id, name);
            });

            return div;
        }

        function updateDocumentCount(count) {
            const badge = document.querySelector('.card-icon.document')?.closest('.card')?.querySelector('.card-count');
            if (badge) badge.textContent = `${count}ä»¶`;
        }

        function displayEmptyState(message) {
            const card = document.querySelector('.card-icon.document')?.closest('.card');
            if (!card) return;

            card.querySelectorAll('.document-item').forEach(el => el.remove());
            card.querySelector('.empty-state')?.remove();

            const viewAllDiv = card.querySelector('.view-all');

            const emptyDiv = document.createElement('div');
            emptyDiv.className = 'empty-state';
            emptyDiv.style.padding = '30px 20px';
            emptyDiv.innerHTML = `
                <i class="fas fa-triangle-exclamation"></i>
                <p>${escapeHtml(message || 'ã‚¨ãƒ©ãƒ¼')}</p>
            `;
            card.insertBefore(emptyDiv, viewAllDiv);
        }

        function downloadDocument(url) {
            if (!url) {
                alert('ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰URLãŒã‚ã‚Šã¾ã›ã‚“');
                return;
            }
            window.open(url, '_blank');
        }

        async function confirmDeleteDocument(docId, fileName) {
            const ok = confirm(`æ›¸é¡ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\n${fileName || ''}`);
            if (!ok) return;

            try {
                // Firestore ãƒ¡ã‚¿å‰Šé™¤
                const docRef = doc(db, 'documents', docId);
                const snap = await getDoc(docRef);
                const data = snap.exists() ? snap.data() : null;

                // Storage ã‚‚å‰Šé™¤ï¼ˆä¿å­˜ãƒ‘ã‚¹ãŒã‚ã‚‹å ´åˆï¼‰
                if (data && data.storagePath) {
                    await deleteObject(storageRef(storage, data.storagePath));
                }

                await deleteDoc(docRef);

                // å†èª­ã¿è¾¼ã¿
                const user = auth.currentUser;
                if (user) await loadRecentDocuments(user.uid);
                
                // æœ€çµ‚ãƒ­ã‚°ã‚¤ãƒ³æ™‚åˆ»ã‚’æ›´æ–°
                const lastLoginP = document.getElementById('last-login-time');
                if (lastLoginP) {
                    const now = new Date();
                    const formatted = formatDateTime(now);
                    lastLoginP.textContent = `æœ€çµ‚ãƒ­ã‚°ã‚¤ãƒ³: ${formatted}`;
                    
                    await setDoc(doc(db, 'users', user.uid), {
                        lastLoginAt: serverTimestamp()
                    }, { merge: true });
                }

                // å„ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’ãƒ­ãƒ¼ãƒ‰
                await loadNextMeeting(user.uid);
                await loadMessages(user.uid);
                await loadCompanies(user.uid);
                await loadActivityStats(user.uid);

                alert('å‰Šé™¤ã—ã¾ã—ãŸ');
            } catch (error) {
                console.error('å‰Šé™¤ã‚¨ãƒ©ãƒ¼:', error);
                alert('å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
            }
        }

        // è£œåŠ©é–¢æ•°
        function getFileIcon(fileTypeOrName) {
            if (!fileTypeOrName) return 'fas fa-file';
            const type = String(fileTypeOrName).toLowerCase();
            if (type.includes('pdf')) return 'fas fa-file-pdf';
            if (type.includes('word') || type.includes('.doc')) return 'fas fa-file-word';
            if (type.includes('image') || type.includes('.jpg') || type.includes('.png')) return 'fas fa-file-image';
            return 'fas fa-file';
        }

        function formatFileSize(bytes) {
            if (!bytes || bytes === 0) return 'ä¸æ˜';
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(0) + ' KB';
            return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
        }

        function formatDate(timestamp) {
            if (!timestamp) return 'ä¸æ˜';
            try {
                const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                return `${year}/${month}/${day}`;
            } catch (e) {
                return 'ä¸æ˜';
            }
        }

        function escapeHtml(str) {
            return String(str || '')
                .replaceAll('&', '&amp;')
                .replaceAll('<', '&lt;')
                .replaceAll('>', '&gt;')
                .replaceAll('"', '&quot;')
                .replaceAll("'", '&#039;');
        }

        // é–‹ç™ºä¸­ã®æ³¨æ„ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼ˆç¾è¡Œå®Ÿè£…ã®æŒ™å‹•ç¶­æŒï¼‰
        document.addEventListener('DOMContentLoaded', function() {
            const interactiveElements = document.querySelectorAll('button:not(.logout-btn), a[href="#"], a[href^="#"]:not([href="#"])');
            interactiveElements.forEach(element => {
                element.addEventListener('click', function(e) {
                    if (this.classList.contains('logout-btn') || (this.href && this.href.includes('index.html'))) return;
                    e.preventDefault();
                    const actionName = this.textContent.trim() || this.title || 'æ©Ÿèƒ½';
                    alert(`ğŸš§ é–‹ç™ºä¸­ã®æ©Ÿèƒ½ã§ã™\n\nã€Œ${actionName}ã€ã¯ç¾åœ¨é–‹ç™ºæº–å‚™ä¸­ã§ã™ã€‚\nå®Œæˆå¾Œã€Firebaseé€£æºã«ã‚ˆã‚Šå®Ÿéš›ã®ãƒ‡ãƒ¼ã‚¿ç®¡ç†æ©Ÿèƒ½ãŒæœ‰åŠ¹ã«ãªã‚Šã¾ã™ã€‚`);
                });
            });
        });

        // ãƒ‡ãƒãƒƒã‚°ç”¨å…¬é–‹
        window.firebaseAuth = auth;
        window.firebaseDb = db;
    </script>

    <!-- JSON-LD æ§‹é€ åŒ–ãƒ‡ãƒ¼ã‚¿ -->
    <script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "WebPage",
        "name": "ãƒã‚¤ãƒšãƒ¼ã‚¸ | å¤§å­¦èµ´ä»»è€…ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼å¸¯åŒãƒ—ãƒ­ã‚°ãƒ©ãƒ ",
        "description": "å¤§å­¦èµ´ä»»è€…å®¶æ—å¸¯åŒæ”¯æ´ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã®ãƒã‚¤ãƒšãƒ¼ã‚¸ã€‚é¢è«‡äºˆç´„ç®¡ç†ã€ä¼æ¥­ç´¹ä»‹ã€å¿œå‹Ÿæ›¸é¡ç®¡ç†ãªã©ã‚’ä¸€å…ƒç®¡ç†ã§ãã¾ã™ã€‚",
        "url": "https://hiyusho.github.io/university-relocation-support/dashboard.html",
        "isPartOf": {
            "@type": "WebSite",
            "name": "å¤§å­¦èµ´ä»»è€…ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼å¸¯åŒãƒ—ãƒ­ã‚°ãƒ©ãƒ ",
            "url": "https://hiyusho.github.io/university-relocation-support/"
        }
    }
    </script>
</body>
</html>
